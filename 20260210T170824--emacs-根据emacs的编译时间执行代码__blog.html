<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-02-20 五 16:43 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>emacs-根据emacs的编译时间执行代码</title>
<meta name="author" content="ahs" />
<meta name="generator" content="Org Mode" />
<link rel='stylesheet' type='text/css' href='/org.css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="preamble" class="status">
<p>▼ 本文更新于 <span class="timestamp-wrapper"><span class="timestamp">[2026-02-12 四 16:15]</span></span></p>
</div>
<div id="content" class="content">
<header>
<h1 class="title">emacs-根据emacs的编译时间执行代码</h1>
</header><p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2026-02-10T17:08:00">[2026-02-10 二 17:08]</time></span><br>
</p>

<p>
又一次例行更新Melpa之后，发现在org文件中 <code>C-c C-q</code> 的tag页面无法补全了。由于我用的 <code>vertico</code> ，经过一番查找，发现了事情的来龙去脉。<br>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2026-02-12T16:15:00">[2026-02-12 四 16:15]</time></span> <code>vertico</code> 的作者已于2026年2月10日回退了相关commit，以下代码对vertico不再适用。<br>
</p>
<div id="outline-container-org8fcc312" class="outline-2">
<h2 id="org8fcc312"><span class="section-number-2">1.</span> vertico失效的来龙去脉</h2>
<div class="outline-text-2" id="text-1">
<p>
在Emacs 30及更早版本中， <code>completing-read-multiple</code> 函数不会向用户提示可以完成多个字符串。vertico的作者minad于<a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=76028">2025年2月就提交过补丁</a>，并<a href="https://github.com/minad/vertico?tab=readme-ov-file#completing-read-multiple">写在了README里面</a>。<br>
</p>

<p>
时间快进到2026年2月8日，emacs官方repo终于<a href="https://github.com/emacs-mirror/emacs/commit/c86094057b0c391d6160ba8c37c6df9bb0370b16">合并了这个补丁</a>。于是minad很高兴，于2026年2月9日<a href="https://github.com/minad/vertico/commit/8f75f18b01ce9baa392469104a3c7dd08c3a608d">修改了vertico的代码</a>，以支持最新的变更。<br>
</p>

<p>
遗憾的是，我用的emacs编译于2026年2月4日，因此恰好错过了最新的Emacs源码，所以我们需要想个办法保持兼容性。<br>
</p>

<p>
需要注意的是，只有用最新Emacs和最新版package的才需要担心这些。如果你用的Melpa-stable、GNU Elpa等源，默认就是release之后才会提交新版本的。当然，代价就是很多package开发者懒得打release，所以可能数月甚至数年才会更新一次。<br>
</p>
</div>
</div>
<div id="outline-container-orgb7a2ee3" class="outline-2">
<h2 id="orgb7a2ee3"><span class="section-number-2">2.</span> 根据编译时间执行代码</h2>
<div class="outline-text-2" id="text-2">
<p>
既然已经确定了变更时间点和变更内容，接下来就简单了。我们找到旧版代码，然后将其稍微包装，添加到配置中：<br>
</p>

<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #c035aa;">(</span><span style="color: #ad45ba;">use-package</span> vertico
  <span style="color: #705ae3;">:demand</span> t <span style="color: #705ae3;">:ensure</span> t
  <span style="color: #705ae3;">:config</span>
  <span style="color: #5165e4;">(</span><span style="color: #ad45ba;">when</span> <span style="color: #007f6f;">(</span><span style="color: #ad45ba;">and</span> emacs-build-time
               <span style="color: #a05b5f;">;; </span><span style="color: #a05b5f;">vertico&#21464;&#26356;&#26102;&#38388;&#28857;
</span>               <span style="color: #ad45ba;">(</span>not <span style="color: #1f6fbf;">(</span>time-less-p <span style="color: #4f7d0f;">(</span>encode-time 0 0 0 8 2 2026<span style="color: #4f7d0f;">)</span> emacs-build-time<span style="color: #1f6fbf;">)</span><span style="color: #ad45ba;">)</span><span style="color: #007f6f;">)</span>
    <span style="color: #a05b5f;">;; </span><span style="color: #a05b5f;">Emacs &#32534;&#35793;&#20110; 2026-02-08 &#20043;&#21069; &#38656;&#35201;&#20351;&#29992;&#26087;&#29256;vertico&#20195;&#30721;
</span>    <span style="color: #007f6f;">(</span><span style="color: #ad45ba;">define-minor-mode</span> <span style="color: #5165e4;">vertico-mode</span>
      <span style="color: #804fb0;">"VERTical Interactive COmpletion."</span>
      <span style="color: #705ae3;">:global</span> t <span style="color: #705ae3;">:group</span> 'vertico
      <span style="color: #ad45ba;">(</span><span style="color: #ad45ba;">dolist</span> <span style="color: #1f6fbf;">(</span>fun '<span style="color: #4f7d0f;">(</span>completing-read-default completing-read-multiple<span style="color: #4f7d0f;">)</span><span style="color: #1f6fbf;">)</span>
        <span style="color: #1f6fbf;">(</span><span style="color: #ad45ba;">if</span> vertico-mode
            <span style="color: #4f7d0f;">(</span>advice-add fun <span style="color: #705ae3;">:around</span> #'vertico--advice<span style="color: #4f7d0f;">)</span>
          <span style="color: #4f7d0f;">(</span>advice-remove fun #'vertico--advice<span style="color: #4f7d0f;">)</span><span style="color: #1f6fbf;">)</span><span style="color: #ad45ba;">)</span><span style="color: #007f6f;">)</span><span style="color: #5165e4;">)</span>
  <span style="color: #5165e4;">(</span>vertico-mode 1<span style="color: #5165e4;">)</span>
</code></pre>
</div>

<p>
这里我们获取到 <code>emacs-build-time</code> 的变量，并把他与我们指定的时间2026年2月8日做比较。如果指定时间 &gt; build-time，则执行后续步骤，恢复旧版的 <code>vertico-mode</code> 代码。<br>
</p>

<p>
然后在这一步执行完毕之后，再启动 <code>vertico-mode</code> 。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.8-pre)　|　<a href="https://blog.prayhand13013.top/rss.xml">RSS</a>　<a href="https://blog.prayhand13013.top/20251121T151653--english-post-index__wiki.html">English-Index</a></p>
</div>
</body>
</html>
