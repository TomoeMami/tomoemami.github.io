<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-01-21 周三 23:12 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>emacs-让beancount插件可以补全收款人</title>
<meta name="generator" content="Org Mode" />
<link rel='stylesheet' type='text/css' href='/org.css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="preamble" class="status">
<p>▼ 本文更新于 <span class="timestamp-wrapper"><span class="timestamp">[2026-01-21 周三 22:55]</span></span></p>
</div>
<div id="content" class="content">
<header>
<h1 class="title">emacs-让beancount插件可以补全收款人</h1>
</header><p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2026-01-21T22:42:00">[2026-01-21 周三 22:42]</time></span><br>
</p>

<p>
最近在AI的指点下，更新了beancount的记账模式，从原来不断开子账户转变为大类账户+收款人+备注。由于这也是beancount官方推荐的备注模式，所以在诸如fava的地方也能很好地利用收款人和备注来匹配筛选出符合条件的交易。<br>
</p>

<p>
注：beancount的一个交易一般如下：<br>
</p>
<div class="org-src-container">
<pre class="src src-beancount"><code><span style="color: #00824f;">2026-01-21</span> <span style="color: #ca3400;">*</span> <span style="color: #ca3400;">"&#25910;&#27454;&#20154;" "&#22791;&#27880;"</span>
  &#36134;&#25143;1   <span style="color: #242521; background-color: #fcf7ef;">1 CNY</span>
  &#36134;&#25143;2   <span style="color: #242521; background-color: #fcf7ef;">-1 CNY</span>
<span style="color: #00824f;">2026-01-21</span> <span style="color: #ca3400;">*</span> <span style="color: #ca3400;">"&#22791;&#27880;"</span>
  &#36134;&#25143;1   <span style="color: #242521; background-color: #fcf7ef;">1 CNY</span>
  &#36134;&#25143;2   <span style="color: #242521; background-color: #fcf7ef;">-1 CNY</span>
</code></pre>
</div>

<p>
但是默认情况下，beancount官方的emacs插件 <code>beancount.el</code> 并未提供收款人的补全。（当然，他们也没有提供账户的指定补全文件功能，默认情况下只补全当前buffer的账户，可以通过我的这篇文章<a href="20250113T235551--emacs-让beancount插件支持中文账户名__blog.html">emacs-让beancount插件支持中文账户名</a>解决。）<br>
</p>
<div id="outline-container-orgfaeb1a3" class="outline-2">
<h2 id="orgfaeb1a3"><span class="section-number-2">1.</span> 收款人补全代码</h2>
<div class="outline-text-2" id="text-1">
<p>
如果想要一个可以选择日期、补全收款人的函数，且你已经在电脑上安装了beancount，可调用 <code>bean-query</code> ，则可参考以下代码（LLM生成，已测试过可用）：<br>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #a7601f;">(</span><span style="color: #006f00;">defvar</span> <span style="color: #007a9f;">my/beancount-payee-cache</span> nil
  <span style="color: #4f677f;">"&#32531;&#23384; Payee &#21015;&#34920;&#20197;&#25552;&#39640;&#34917;&#20840;&#36895;&#24230;&#12290;"</span><span style="color: #a7601f;">)</span>
<span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">my/beancount-refresh-payee-cache</span> <span style="color: #557400;">()</span>
  <span style="color: #4f677f;">"&#24378;&#21046;&#21047;&#26032; Payee &#32531;&#23384;&#12290;&#20174; bean-query &#33719;&#21462;&#26368;&#26032;&#25968;&#25454;&#24182;&#28165;&#29702;&#26684;&#24335;&#12290;"</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">interactive</span><span style="color: #557400;">)</span>
  <span style="color: #557400;">(</span>message <span style="color: #ca3400;">"&#27491;&#22312;&#33719;&#21462; Beancount &#25910;&#27454;&#20154;&#21015;&#34920;..."</span><span style="color: #557400;">)</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">let*</span> <span style="color: #bf4400;">(</span><span style="color: #3f6faf;">(</span>file <span style="color: #00824f;">(</span>buffer-file-name<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>query <span style="color: #ca3400;">"SELECT distinct payee WHERE payee != ''"</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>cmd <span style="color: #00824f;">(</span>format <span style="color: #ca3400;">"bean-query -f csv %s %S"</span> 
                      <span style="color: #9a456f;">(</span>shell-quote-argument <span style="color: #a2604f;">(</span>expand-file-name file<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span> 
                      query<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">1. &#25191;&#34892;&#21629;&#20196;&#24182;&#22788;&#29702; Windows &#25442;&#34892;&#31526; (^M)
</span>         <span style="color: #3f6faf;">(</span>raw-output <span style="color: #00824f;">(</span>shell-command-to-string cmd<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>clean-output <span style="color: #00824f;">(</span>replace-regexp-in-string <span style="color: #ca3400;">"\r"</span> <span style="color: #ca3400;">""</span> raw-output<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>lines <span style="color: #00824f;">(</span>split-string clean-output <span style="color: #ca3400;">"\n"</span> t<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span>
    
    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">2. &#25552;&#21462;&#25968;&#25454;
</span>    <span style="color: #bf4400;">(</span><span style="color: #006f00;">let</span> <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>payees <span style="color: #9a456f;">(</span><span style="color: #006f00;">if</span> <span style="color: #a2604f;">(</span><span style="color: #006f00;">and</span> lines <span style="color: #007a9f;">(</span>string= <span style="color: #9f0d0f;">(</span>car lines<span style="color: #9f0d0f;">)</span> <span style="color: #ca3400;">"payee"</span><span style="color: #007a9f;">)</span><span style="color: #a2604f;">)</span>
                      <span style="color: #a2604f;">(</span>cdr lines<span style="color: #a2604f;">)</span> <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#31227;&#38500; CSV &#34920;&#22836;
</span>                    lines<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
      <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">3. &#28165;&#29702;&#27599;&#19968;&#34892;&#30340;&#21452;&#24341;&#21495;&#24182;&#23384;&#20837;&#32531;&#23384;
</span>      <span style="color: #3f6faf;">(</span><span style="color: #006f00;">setq</span> my/beancount-payee-cache 
            <span style="color: #00824f;">(</span>mapcar <span style="color: #9a456f;">(</span><span style="color: #006f00;">lambda</span> <span style="color: #a2604f;">(</span>s<span style="color: #a2604f;">)</span> 
                      <span style="color: #a2604f;">(</span>replace-regexp-in-string <span style="color: #ca3400;">"^\"</span><span style="color: #8448aa;">\\</span><span style="color: #007a9f;">|</span><span style="color: #ca3400;">\"$"</span> <span style="color: #ca3400;">""</span> s<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span> 
                    payees<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span>
    <span style="color: #bf4400;">(</span>message <span style="color: #ca3400;">"&#25910;&#27454;&#20154;&#32531;&#23384;&#21047;&#26032;&#23436;&#27605;&#65292;&#20849; %d &#20010;&#12290;"</span> <span style="color: #3f6faf;">(</span>length my/beancount-payee-cache<span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span>
    my/beancount-payee-cache<span style="color: #557400;">)</span><span style="color: #a7601f;">)</span>
<span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">my/beancount-get-payees-with-cache</span> <span style="color: #557400;">()</span>
  <span style="color: #4f677f;">"&#33719;&#21462;&#25910;&#27454;&#20154;&#21015;&#34920;&#12290;&#22914;&#26524;&#32531;&#23384;&#20026;&#31354;&#65292;&#21017;&#36827;&#34892;&#31532;&#19968;&#27425;&#21152;&#36733;&#12290;"</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">if</span> my/beancount-payee-cache
      my/beancount-payee-cache
    <span style="color: #bf4400;">(</span>my/beancount-refresh-payee-cache<span style="color: #bf4400;">)</span><span style="color: #557400;">)</span><span style="color: #a7601f;">)</span>
<span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#21033;&#29992;calendar&#30028;&#38754;&#36873;&#25321;&#26085;&#26399;&#65292;&#24555;&#36895;&#25554;&#20837;beancount&#30340;entry
</span><span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">beancount-insert-chosen-date</span> <span style="color: #557400;">()</span>
   <span style="color: #4f677f;">"&#25554;&#20837; Beancount &#26684;&#24335;&#30340;&#26085;&#26399;&#12289;Payee &#21644;&#22791;&#27880;&#12290;
Payee &#25903;&#25345;&#20174;&#21382;&#21490;&#35760;&#24405;&#20013;&#34917;&#20840;&#12290;"</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">interactive</span><span style="color: #557400;">)</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">let*</span> <span style="color: #bf4400;">(</span><span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">1. &#33719;&#21462;&#26085;&#26399; (&#20445;&#30041;&#20320;&#21407;&#26469;&#30340; org-time-stamp &#36923;&#36753;)
</span>         <span style="color: #3f6faf;">(</span>date <span style="color: #00824f;">(</span>substring
                <span style="color: #9a456f;">(</span><span style="color: #006f00;">with-temp-buffer</span>
                  <span style="color: #a2604f;">(</span>org-time-stamp nil nil<span style="color: #a2604f;">)</span>
                  <span style="color: #a2604f;">(</span>buffer-string<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span>
                1 11<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">2. &#33719;&#21462; Payee &#21015;&#34920;&#29992;&#20110;&#34917;&#20840;
</span>         <span style="color: #3f6faf;">(</span>payee-list <span style="color: #00824f;">(</span>my/beancount-get-payees-with-cache<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">1. &#36755;&#20837; Payee
</span>         <span style="color: #3f6faf;">(</span>payee <span style="color: #00824f;">(</span>completing-read <span style="color: #ca3400;">"&#25910;&#27454;&#20154;: "</span> payee-list<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         
         <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">2. &#36755;&#20837; Narration
</span>         <span style="color: #3f6faf;">(</span>narration <span style="color: #00824f;">(</span>read-string <span style="color: #ca3400;">"&#22791;&#12288;&#27880;: "</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span>
    
    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#25554;&#20837;&#26085;&#26399;&#21644;&#26071;&#26631;
</span>    <span style="color: #bf4400;">(</span>insert date <span style="color: #ca3400;">" * "</span><span style="color: #bf4400;">)</span>
    
    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#25554;&#20837; Payee &#21644; Narration
</span>    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#26681;&#25454; Beancount &#35821;&#27861;&#65306;&#22914;&#26524;&#20004;&#20010;&#37117;&#26377;&#65292;&#26684;&#24335;&#20026; "Payee" "Narration"
</span>    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#22914;&#26524;&#21482;&#26377;&#19968;&#20010;&#65292;&#40664;&#35748;&#20026; Narration
</span>    <span style="color: #bf4400;">(</span><span style="color: #006f00;">cond</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span><span style="color: #006f00;">and</span> <span style="color: #9a456f;">(</span>not <span style="color: #a2604f;">(</span>string-empty-p payee<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span> <span style="color: #9a456f;">(</span>not <span style="color: #a2604f;">(</span>string-empty-p narration<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span>
      <span style="color: #00824f;">(</span>insert <span style="color: #9a456f;">(</span>format <span style="color: #ca3400;">"\"%s\" \"%s\""</span> payee narration<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>not <span style="color: #9a456f;">(</span>string-empty-p payee<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span>
      <span style="color: #00824f;">(</span>insert <span style="color: #9a456f;">(</span>format <span style="color: #ca3400;">"\"%s\""</span> payee<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span>t 
      <span style="color: #00824f;">(</span>insert <span style="color: #ca3400;">"\"\""</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span> <span style="color: #8f6f4a;">; </span><span style="color: #8f6f4a;">&#22343;&#20026;&#31354;&#21017;&#25554;&#20837;&#31354;&#24341;&#21495;
</span>    
    <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#25442;&#34892;&#24182;&#32553;&#36827;
</span>    <span style="color: #bf4400;">(</span>insert <span style="color: #ca3400;">"\n  "</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span><span style="color: #a7601f;">)</span>
</code></pre>
</div>

<p>
然后再设置beancount，用这个函数替代默认的 <code>beancount-insert-date</code> 快捷键 <code>M-RET</code><br>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #a7601f;">(</span><span style="color: #006f00;">use-package</span> beancount
  <span style="color: #557400;">:mode</span>
  <span style="color: #557400;">(</span><span style="color: #ca3400;">"\\.bean</span><span style="color: #8448aa;">\\</span><span style="color: #007a9f;">(?:</span><span style="color: #ca3400;">count</span><span style="color: #8448aa;">\\</span><span style="color: #007a9f;">)</span><span style="color: #ca3400;">?\\'"</span> . beancount-mode<span style="color: #557400;">)</span>
  <span style="color: #557400;">:bind</span>
  <span style="color: #557400;">(</span><span style="color: #557400;">:map</span> beancount-mode-map
        <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#32465;&#23450;&#19968;&#20010;&#24555;&#25463;&#36755;&#20837;&#26085;&#26399;&#30340;&#33258;&#23450;&#20041;&#20989;&#25968;
</span>        <span style="color: #bf4400;">(</span><span style="color: #ca3400;">"M-RET"</span> . beancount-insert-chosen-date<span style="color: #bf4400;">)</span><span style="color: #557400;">)</span>
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org404df97" class="outline-2">
<h2 id="org404df97"><span class="section-number-2">2.</span> 使用说明</h2>
<div class="outline-text-2" id="text-2">
<p>
在beancount的文件中，如 <code>2026.bean</code> ，按下 <code>M-RET</code> ，会弹出org-mode的日期选择窗口。选择好日期后，会提示你输入收款人（带补全），再提示输入备注。如果收款人不为空且备注为空，则会用收款人接收到的字符串作为备注使用（beancount默认行为）。<br>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.8-pre)　|　<a href="https://blog.prayhand13013.top/rss.xml">RSS</a>　<a href="https://blog.prayhand13013.top/20251121T151653--english-post-index__wiki.html">English-Index</a></p>
</div>
</body>
</html>
