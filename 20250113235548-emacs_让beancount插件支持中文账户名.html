<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-01-16 周四 00:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>+emacs+让beancount插件支持中文账户名</title>
<meta name="generator" content="Org Mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
/*@import url("https://fonts.googleapis.com/css2?family=Lora:wght@500&display=fallback");
@import url("https://fonts.googleapis.com/css2?family=Inconsolata&display=fallback");
*/

body {
    margin: 2% auto;
    width: 90%;
    max-width: 100%;
    background-color: rgba(242,229,188,0.5);
    /* background-color: rgba(255,255,255,0.5); */
    font-size: 18px;
    line-height: 1.4em;
}
@media screen and (min-width: 600px) {
    body {
        font-size: 18px;
    }
}

@media screen and (min-width: 910px) {
    body {
        width: 900px;
    }
}
#preamble {
    width: 80%;
    max-width: 980px;
    text-align: right;
    margin: auto;
}

hr {
    border: none;
    border-top: 5px double #333;
    margin: 0px 0;
}

.button {
    border: none;
    color: black;
    padding: 6px 14px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    margin: 4px 2px;
    transition-duration: 0.4s;
    cursor: pointer;
}

.button:hover {
    background-color: #3a1616;
    color: white;
}

.todo {
    background-color: #9d0006;
    color: #fbf1c7;
    padding: .1em 0.3em;
    border-radius: 3px;
    background-clip: padding-box;
    font-size: $code-size;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    line-height: 1;
}

.done {
    background-color: #427b58;
    color: #fbf1c7;
    padding: .1em 0.3em;
    border-radius: 3px;
    background-clip: padding-box;
    font-size: $code-size;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
    line-height: 1;
}

#postamble p {
    font-size: 80%;
    margin: .2em;
}

#content, .content {
    width: 80%;
    max-width: 980px;
    margin: auto;
}

#org-div-home-and-up{
    position: fixed;
    right: 0.5em;
    margin-top: 70px;
    font-family:sans-serif;
}

#table-of-contents {
    margin-top: 105px;
    font-size: 12pt;
    position: fixed;
    left: 0em;
    top: 0em;
    background: white;
    max-height: 80%;
    overflow: auto;
}

#table-of-contents h2 {
    display: none;
}
#table-of-contents li {
    clear: both;
}
.timestamp {
    color: #928374;
    font-size: $smaller;
}

.timestamp-kwd {
    color: #5f9ea0;
}

@media screen and (max-width: 1200px) {
    #table-of-contents {
        position: relative;
        margin-top: 0px;
    }
}

/* p:not(blockquote > p) :not(ol > p) { */
/*     text-indent: 2em; */
/* } */
p {
    margin: 1em auto;
}

.title {
    font-size: 30px;
    line-height: 1.3;
    font-weight: bold;
    color: #0c2340;
}

h2:not(#table-of-contents > h2) {
    font-size: 30px;
    line-height: 1.2;
    position: relative;
    color: #204060;
}

h2::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background-color: black;
}

h3:not(#table-of-contents > h3) {
    font-size: 20px;
    line-height: 1.1;
    position: relative;
    color: #4b748d;
}

h3::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    /* border-bottom: 1px dashed black; */
}

h4 {
    font-size: 14px;
    line-height: 1.1;
    font-weight: bold;
}


a {
    cursor: pointer;
    text-decoration: none;
}

a:link {
    color: #458588;
    /* text-decoration: underline; */
}

a:hover {
    /* font-weight: bold; */
    text-decoration: underline;
    /* color: #076678; */
}

.figure {
    text-align: center;
}

a:visited{
    color: #8f3f71;
    /* text-decoration: underline; */
}

img {
    max-width: 100%;
    vertical-align: middle;
}
.MathJax_Display {
    margin: 0!important;
    width: $smaller!important;
}
@media screen and (max-width: 1200px) {
    img {
        width: 400px;
    }
    .MathJax_Display {
        margin: 0!important;
        width: $smaller!important;
    }
}

.org-src-container {
    font-size: 14px;
    outline: 2px dashed #ccc;
    outline-offset: 10px;
    position: relative;

}
.org-src-container>pre {
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Cascadia Code,Consolas, Liberation Mono, monospace;
}

.org-src-container>pre:before {
    display: block;
    position: absolute;
    background-color: #b3b3b3;
    top: 0;
    right: 0;
    padding: 0 0.5em;
    border-bottom-left-radius: 8px;
    border: 0;
    color: white;
    font-size: $code-size;

}
pre {
    overflow: auto;

}
.example{
    font-size: 14px;
    outline: 2px dashed #ccc;
    outline-offset: 10px;
    position: relative;
    
}
.example::before {
    content: "Results";
}
pre:before {
    display: block;
    position: absolute;
    background-color: #b3b3b3;
    top: 0;
    right: 0;
    padding: 0 0.5em;
    border-bottom-left-radius: 8px;
    border: 0;
    color: white;
    font-size: $code-size;
}
/* .org-src-container::before { */
/*     content: "Copy"; */
/*     position: absolute; */
/*     top: 5px; */
/*     right: 5px; */
/*     padding: 5px; */
/*     background-color: #ccc; */
/*     color: #fff; */
/*     border-radius: 3px; */
/*     cursor: pointer; */
/* } */

code {
    font-size: 16px;
    color: #427b58;
}

.subtitle {
    text-align: right;
}

blockquote {
    border-left: 3px solid #ccc;
    padding-left: 10px; /* Optional: add some left padding for the content */
    margin-inline-start: 0px;
    margin-inline-end: 0px;
}

.info {
    overflow: hidden;
}

.created {
    float: right;
}

.updated {
    float: left;
}

.org-ol {
    list-style-type: decimal; /* Set the list style type to decimal numbers */
    /* margin-left: 0.5em; /\* Add left margin to the list *\/ */
}

b {
    color: #9d0006;
}

#footnotes {
    position: fixed;
    left: auto;
    right: 0;
    top: 105px;
    bottom: 0;
    width: 20%;
    padding: 10px;
    overflow: auto;
    font-size: 14px;
    z-index: 9999;
}

#footnotes h2 {
    display: none;
}

@media screen and (max-width: 1200px) {
    #footnotes {
        position: static;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-height: 30%;
        overflow: auto;
        padding: 10px;
        font-size: 14px;
        z-index: 9999;
    }
}
/*]]>*/-->
 </style>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">+emacs+让beancount插件支持中文账户名</h1>
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2025-01-13 周一 23:55]</span></span><br />
</p>

<p>
beancoun使用时，只需要确保首项固定大类和次项以英文/数字开头即可，后续账户可用纯中文。<br />
</p>

<p>
这里不使用<code>package</code>中的<code>beancount.el</code>，因为它用常量定义了一些正则语句，我们改用自行修改后的本地<code>beancount.el</code>。<br />
</p>

<p>
在<code>use-package</code>中配置本地文件载入路径：<br />
</p>
<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #458588;">(</span><span style="color: #9d0006;">use-package</span> <span style="color: #8f3f71;">beancount</span>
  <span style="color: #af3a03;">:mode</span>
  <span style="color: #b16286;">(</span><span style="color: #79740e;">"\\.bean</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">count</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">?\\'"</span> . beancount-mode<span style="color: #b16286;">)</span>
  <span style="color: #af3a03;">:load-path</span> <span style="color: #79740e;">"~/elpa/"</span>
  <span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">&#37197;&#32622;&#36134;&#25143;&#34917;&#20840;&#25991;&#20214;&#36335;&#24452;</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> beancount-account-files '<span style="color: #b16286;">(</span><span style="color: #79740e;">"/path/to/accounts.bean"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span> 
</pre>
</div>

<p>
账户补全原理及解说参考<a href="https://whatacold.io/zh-cn/blog/2022-09-10-emacs-beancount-account-files/">这个链接</a>。<br />
</p>

<p>
然后在载入路径（这里是<code>~/elpa/</code>下保存一个名为<code>beancoun.el</code>的文件，内容如下：<br />
</p>

<div class="org-src-container">
<pre class="src src-elisp"><span style="color: #a89984;">;;; </span><span style="color: #a89984;">beancount.el --- A major mode to edit Beancount input files. -*- lexical-binding: t -*-</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">Copyright (C) 2013 Martin Blais <a href="mailto:blais%40furius.ca">&lt;blais@furius.ca&gt;</a></span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">Copyright (C) 2015 Free Software Foundation, Inc.</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">Copyright (C) 2019 Daniele Nicolodi <a href="mailto:daniele%40grinta.net">&lt;daniele@grinta.net&gt;</a></span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">Version: 0.9</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">Author: Martin Blais <a href="mailto:blais%40furius.ca">&lt;blais@furius.ca&gt;</a></span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">Author: Stefan Monnier <a href="mailto:monnier%40iro.umontreal.ca">&lt;monnier@iro.umontreal.ca&gt;</a></span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">Author: Daniele Nicolodi <a href="mailto:daniele%40grinta.net">&lt;daniele@grinta.net&gt;</a></span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">This file is not part of GNU Emacs.</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">This package is free software: you can redistribute it and/or modify</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">it under the terms of the GNU General Public License as published by</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">the Free Software Foundation, either version 3 of the License, or</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">(at your option) any later version.</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">This package is distributed in the hope that it will be useful,</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">GNU General Public License for more details.</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">You should have received a copy of the GNU General Public License</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">along with this package.  If not, see <a href="http://www.gnu.org/licenses/">&lt;http://www.gnu.org/licenses/&gt;</a>.</span>

<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Commentary:</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">TODO: Add a flymake rule, using bean-check</span>

<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Code:</span>

<span style="color: #458588;">(</span>autoload 'ido-completing-read <span style="color: #79740e;">"ido"</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">subr-x</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">outline</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">thingatpt</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">cl-lib</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">xref</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">apropos</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">require</span> '<span style="color: #8f3f71;">rx</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;;;</span><span style="color: #a89984;">###</span><span style="color: #9d0006; font-weight: bold;">autoload</span>
<span style="color: #458588;">(</span>add-to-list 'auto-mode-alist '<span style="color: #b16286;">(</span><span style="color: #79740e;">"\\.beancount\\'"</span> . beancount-mode<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defgroup</span> <span style="color: #8f3f71;">beancount</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Editing mode for Beancount files."</span>
  <span style="color: #af3a03;">:group</span> 'beancount<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defcustom</span> <span style="color: #076678;">beancount-transaction-indent</span> 2
  <span style="color: #79740e;">"Transaction indent."</span>
  <span style="color: #af3a03;">:type</span> 'integer<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defcustom</span> <span style="color: #076678;">beancount-number-alignment-column</span> 52
  <span style="color: #79740e;">"Column to which align numbers in posting definitions. Set to</span>
<span style="color: #79740e;">0 to automatically determine the minimum column that will allow</span>
<span style="color: #79740e;">to align all amounts."</span>
  <span style="color: #af3a03;">:type</span> 'integer<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defcustom</span> <span style="color: #076678;">beancount-highlight-transaction-at-point</span> nil
  <span style="color: #79740e;">"If t highlight transaction under point."</span>
  <span style="color: #af3a03;">:type</span> 'boolean<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defcustom</span> <span style="color: #076678;">beancount-use-ido</span> t
  <span style="color: #79740e;">"If non-nil, use ido-style completion rather than the standard."</span>
  <span style="color: #af3a03;">:type</span> 'boolean<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defcustom</span> <span style="color: #076678;">beancount-electric-currency</span> nil
  <span style="color: #79740e;">"If non-nil, make `</span><span style="color: #8f3f71;">newline</span><span style="color: #79740e;">' try to add missing currency to</span>
<span style="color: #79740e;">complete the posting at point. The correct currency is determined</span>
<span style="color: #79740e;">from the open directive for the relevant account."</span>
  <span style="color: #af3a03;">:type</span> 'boolean<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defgroup</span> <span style="color: #8f3f71;">beancount-faces</span> nil <span style="color: #79740e;">"Beancount mode highlighting"</span> <span style="color: #af3a03;">:group</span> 'beancount<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-directive</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-keyword-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount directives."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-tag</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-type-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount tags."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-link</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-type-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount links."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-date</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-constant-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount dates."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-account</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-builtin-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount account names."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-amount</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> default<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount amounts."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-narrative</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-builtin-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount transactions narrative."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-narrative-cleared</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-string-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount cleared transactions narrative."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-narrative-pending</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-keyword-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount pending transactions narrative."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-metadata</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> font-lock-type-face<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face for Beancount metadata."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-highlight</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> highlight<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Face to highlight Beancount transaction at point."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-1</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-1<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 1."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-2</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-2<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 2."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-3</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-3<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 3."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-4</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-4<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 4."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-5</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-5<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 5."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-6</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-6<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 6."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-7</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-7<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 7."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defface</span> <span style="color: #076678;">beancount-outline-8</span>
  '<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>t <span style="color: #af3a03;">:inherit</span> outline-8<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Outline level 8."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-account-directive-names</span>
  '<span style="color: #b16286;">(</span><span style="color: #79740e;">"balance"</span>
    <span style="color: #79740e;">"close"</span>
    <span style="color: #79740e;">"document"</span>
    <span style="color: #79740e;">"note"</span>
    <span style="color: #79740e;">"open"</span>
    <span style="color: #79740e;">"pad"</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Directive names that can appear after a date and are followd by an account."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-no-account-directive-names</span>
  '<span style="color: #b16286;">(</span><span style="color: #79740e;">"commodity"</span>
    <span style="color: #79740e;">"event"</span>
    <span style="color: #79740e;">"price"</span>
    <span style="color: #79740e;">"query"</span>
    <span style="color: #79740e;">"txn"</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Directives with a date but without an account.</span>

<span style="color: #79740e;">List of directive names that can appear after a date and that are</span>
<span style="color: #79740e;">_not_ followed by an account."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-timestamped-directive-names</span>
  <span style="color: #b16286;">(</span>append beancount-account-directive-names
          beancount-no-account-directive-names<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Directive names that can appear after a date."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-directive-names</span>
  '<span style="color: #b16286;">(</span><span style="color: #79740e;">"include"</span>
    <span style="color: #79740e;">"option"</span>
    <span style="color: #79740e;">"plugin"</span>
    <span style="color: #79740e;">"poptag"</span>
    <span style="color: #79740e;">"pushtag"</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Directive names that can appear at the beginning of a line."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-account-categories</span>
  '<span style="color: #b16286;">(</span><span style="color: #79740e;">"Assets"</span> <span style="color: #79740e;">"Liabilities"</span> <span style="color: #79740e;">"Equity"</span> <span style="color: #79740e;">"Income"</span> <span style="color: #79740e;">"Expenses"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-tag-chars</span> <span style="color: #79740e;">"[:alnum:]-_/."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-account-chars</span> <span style="color: #79740e;">"[:alnum:]-_\\cC:"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-option-names</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">This list is kept in sync with the options defined in</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">beancount/parser/options.py.</span>
  '<span style="color: #b16286;">(</span><span style="color: #79740e;">"account_current_conversions"</span>
    <span style="color: #79740e;">"account_current_earnings"</span>
    <span style="color: #79740e;">"account_previous_balances"</span>
    <span style="color: #79740e;">"account_previous_conversions"</span>
    <span style="color: #79740e;">"account_previous_earnings"</span>
    <span style="color: #79740e;">"account_rounding"</span>
    <span style="color: #79740e;">"account_unrealized_gains"</span>
    <span style="color: #79740e;">"allow_deprecated_none_for_tags_and_links"</span>
    <span style="color: #79740e;">"allow_pipe_separator"</span>
    <span style="color: #79740e;">"booking_method"</span>
    <span style="color: #79740e;">"conversion_currency"</span>
    <span style="color: #79740e;">"documents"</span>
    <span style="color: #79740e;">"infer_tolerance_from_cost"</span>
    <span style="color: #79740e;">"inferred_tolerance_default"</span>
    <span style="color: #79740e;">"inferred_tolerance_multiplier"</span>
    <span style="color: #79740e;">"insert_pythonpath"</span>
    <span style="color: #79740e;">"long_string_maxlines"</span>
    <span style="color: #79740e;">"name_assets"</span>
    <span style="color: #79740e;">"name_equity"</span>
    <span style="color: #79740e;">"name_expenses"</span>
    <span style="color: #79740e;">"name_income"</span>
    <span style="color: #79740e;">"name_liabilities"</span>
    <span style="color: #79740e;">"operating_currency"</span>
    <span style="color: #79740e;">"plugin_processing_mode"</span>
    <span style="color: #79740e;">"render_commas"</span>
    <span style="color: #79740e;">"title"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-date-regexp</span> <span style="color: #79740e;">"[0-9]\\{4\\}[-/][0-9]\\{2\\}[-/][0-9]\\{2\\}"</span>
  <span style="color: #79740e;">"A regular expression to match dates."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-account-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #8ec07c;">(</span>regexp-opt beancount-account-categories<span style="color: #8ec07c;">)</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">:[[:alnum:]-_\\cC]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">+"</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"A regular expression to match account names.&#29616;&#25903;&#25345;&#20013;&#25991;"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-number-regexp</span> <span style="color: #79740e;">"[-+]?[0-9]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">,[0-9]\\{3\\}</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">\\.[0-9]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">?"</span>
  <span style="color: #79740e;">"A regular expression to match decimal numbers."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-currency-regexp</span> <span style="color: #79740e;">"[A-Z][A-Z-_'.]*"</span>
  <span style="color: #79740e;">"A regular expression to match currencies."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-flag-regexp</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">Single char that is neither a space nor a lower-case letter.</span>
  <span style="color: #79740e;">"[</span><span style="color: #79740e;">^</span><span style="color: #79740e;"> a-z]"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-transaction-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-date-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">txn+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">|</span><span style="color: #79740e;">"</span> beancount-flag-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">\".*\"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-posting-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^\\s-+"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-account-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-number-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
          <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-currency-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">?"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-balance-regexp</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">The grouping in this regular expression matches the one in</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">`</span><span style="color: #8f3f71;">beancount-posting-regexp</span><span style="color: #a89984;">' to be used in amount align</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">machinery. See `</span><span style="color: #8f3f71;">beancount-align-number</span><span style="color: #a89984;">'.</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^"</span> beancount-date-regexp <span style="color: #79740e;">"\\s-+balance\\s-+"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-account-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\s-+"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-number-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-currency-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-directive-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> <span style="color: #8ec07c;">(</span>regexp-opt beancount-directive-names<span style="color: #8ec07c;">)</span> <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-timestamped-directive-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-date-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> <span style="color: #8ec07c;">(</span>regexp-opt beancount-timestamped-directive-names<span style="color: #8ec07c;">)</span> <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-metadata-regexp</span>
  <span style="color: #79740e;">"^\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[a-z][A-Za-z0-9_-]+:</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">.+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-open-directive-regexp</span>
  <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-date-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">open</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;"> +"</span>
          <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-account-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">This is a grouping regular expression because the subexpression is</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">used in determining the outline level in `</span><span style="color: #8f3f71;">beancount-outline-level</span><span style="color: #a89984;">'.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-outline-regexp</span> <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">;;;+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">|</span><span style="color: #79740e;">\\*+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">Regular expression for all symbols recognised by the Xref backend.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount-xref-symbol-regexp</span>
  <span style="color: #b16286;">(</span>rx-to-string `<span style="color: #8ec07c;">(</span><span style="color: #9d0006;">or</span> <span style="color: #d65d0e;">(</span>regexp ,beancount-account-regexp<span style="color: #d65d0e;">)</span>
                     <span style="color: #d65d0e;">(</span>regexp ,<span style="color: #458588;">(</span>concat <span style="color: #79740e;">"#["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
                     <span style="color: #d65d0e;">(</span>regexp ,<span style="color: #458588;">(</span>concat <span style="color: #79740e;">"\\^["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-outline-level</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>len <span style="color: #458588;">(</span>- <span style="color: #b16286;">(</span>match-end 1<span style="color: #b16286;">)</span> <span style="color: #b16286;">(</span>match-beginning 1<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>string-equal <span style="color: #458588;">(</span>substring <span style="color: #b16286;">(</span>match-string 1<span style="color: #b16286;">)</span> 0 1<span style="color: #458588;">)</span> <span style="color: #79740e;">";"</span><span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>- len 2<span style="color: #d65d0e;">)</span>
      len<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-face-by-state</span> <span style="color: #b16286;">(</span>state<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">cond</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>string-equal state <span style="color: #79740e;">"*"</span><span style="color: #d65d0e;">)</span> 'beancount-narrative-cleared<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>string-equal state <span style="color: #79740e;">"!"</span><span style="color: #d65d0e;">)</span> 'beancount-narrative-pending<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span>t 'beancount-narrative<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-outline-face</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> outline-minor-mode
      <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cl-case</span> <span style="color: #d65d0e;">(</span>funcall outline-level<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>1 'beancount-outline-1<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>2 'beancount-outline-2<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>3 'beancount-outline-3<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>4 'beancount-outline-4<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>5 'beancount-outline-5<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>6 'beancount-outline-6<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>7 'beancount-outline-7<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>8 'beancount-outline-8<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>otherwise nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    nil<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-font-lock-keywords</span>
  `<span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>,beancount-transaction-regexp <span style="color: #d65d0e;">(</span>1 'beancount-date<span style="color: #d65d0e;">)</span>
                                   <span style="color: #d65d0e;">(</span>2 <span style="color: #458588;">(</span>beancount-face-by-state <span style="color: #b16286;">(</span>match-string 2<span style="color: #b16286;">)</span><span style="color: #458588;">)</span> t<span style="color: #d65d0e;">)</span>
                                   <span style="color: #d65d0e;">(</span>3 <span style="color: #458588;">(</span>beancount-face-by-state <span style="color: #b16286;">(</span>match-string 2<span style="color: #b16286;">)</span><span style="color: #458588;">)</span> t<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>,beancount-posting-regexp <span style="color: #d65d0e;">(</span>1 'beancount-account<span style="color: #d65d0e;">)</span>
                               <span style="color: #d65d0e;">(</span>2 'beancount-amount nil <span style="color: #af3a03;">:lax</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>,beancount-metadata-regexp <span style="color: #d65d0e;">(</span>1 'beancount-metadata<span style="color: #d65d0e;">)</span>
                                <span style="color: #d65d0e;">(</span>2 'beancount-metadata t<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>,beancount-directive-regexp <span style="color: #d65d0e;">(</span>1 'beancount-directive<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>,beancount-timestamped-directive-regexp <span style="color: #d65d0e;">(</span>1 'beancount-date<span style="color: #d65d0e;">)</span>
                                             <span style="color: #d65d0e;">(</span>2 'beancount-directive<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Fontify section headers when composed with outline-minor-mode.</span>
    <span style="color: #8ec07c;">(</span>,<span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-outline-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">.*"</span><span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>0 <span style="color: #458588;">(</span>beancount-outline-face<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Tags and links.</span>
    <span style="color: #8ec07c;">(</span>,<span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"\\#["</span> beancount-tag-chars <span style="color: #79740e;">"]*"</span><span style="color: #d65d0e;">)</span> . 'beancount-tag<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>,<span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"\\^["</span> beancount-tag-chars <span style="color: #79740e;">"]*"</span><span style="color: #d65d0e;">)</span> . 'beancount-link<span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Accounts not covered by previous rules.</span>
    <span style="color: #8ec07c;">(</span>,beancount-account-regexp . 'beancount-account<span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Number followed by currency not covered by previous rules.</span>
    <span style="color: #8ec07c;">(</span>,<span style="color: #d65d0e;">(</span>concat beancount-number-regexp <span style="color: #79740e;">"\\s-+"</span> beancount-currency-regexp<span style="color: #d65d0e;">)</span> . 'beancount-amount<span style="color: #8ec07c;">)</span>
    <span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-tab-dwim</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> outline-minor-mode
           <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> arg <span style="color: #458588;">(</span>outline-on-heading-p<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
      <span style="color: #8ec07c;">(</span>beancount-outline-cycle arg<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>indent-for-tab-command<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-mode-map-prefix</span> <span style="color: #b16286;">[</span><span style="color: #8ec07c;">(</span>control c<span style="color: #8ec07c;">)</span><span style="color: #b16286;">]</span>
  <span style="color: #79740e;">"The prefix key used to bind Beancount commands in Emacs"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-mode-old-style-keybindings</span> nil
  <span style="color: #79740e;">"*Set this to non-nil to continue using old-style keybindings.</span>

<span style="color: #79740e;">In mid-2023, `</span><span style="color: #8f3f71;">beancount-mode</span><span style="color: #79740e;">' changed the keybindings for many of its</span>
<span style="color: #79740e;">commands.  This was because the old bindings violated the Emacs</span>
<span style="color: #79740e;">keybinding standards (see section \"Key Binding Conventions\" in the</span>
<span style="color: #79740e;">Emacs Lisp documentation).  However, you might be accustomed to the</span>
<span style="color: #79740e;">old bindings and prefer to continue using them; this variable offers a</span>
<span style="color: #79740e;">convenient way to do so.  If it is non-nil when `</span><span style="color: #8f3f71;">beancount.el</span><span style="color: #79740e;">' is</span>
<span style="color: #79740e;">loaded, then the old bindings will also be made available.  (The new</span>
<span style="color: #79740e;">bindings will be left in place too, since the key sequences they use</span>
<span style="color: #79740e;">are reserved for the mode anyway.)"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-mode-map</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>map <span style="color: #458588;">(</span>make-sparse-keymap<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>p beancount-mode-map-prefix<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>kbd <span style="color: #79740e;">"TAB"</span><span style="color: #d65d0e;">)</span> #'beancount-tab-dwim<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>kbd <span style="color: #79740e;">"M-RET"</span><span style="color: #d65d0e;">)</span> #'beancount-insert-date<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>\'<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-insert-account<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-transaction-clear<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control l<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-check<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control q<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-query<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control x<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-context<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control k<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-linked<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control r<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-region-default<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control t<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-region-value<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control y<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-region-cost<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control i<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-insert-prices<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>left<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-date-down-day<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>right<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-date-up-day<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>\;<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-align-to-previous-number<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>define-key map <span style="color: #d65d0e;">(</span>vconcat p <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>\:<span style="color: #b16286;">)</span><span style="color: #458588;">]</span><span style="color: #d65d0e;">)</span> #'beancount-align-numbers<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">when</span> beancount-mode-old-style-keybindings
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>control g<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-transaction-clear<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>l<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-check<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>q<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-query<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>x<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-context<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>k<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-linked<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>r<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-region-default<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>t<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-region-value<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>y<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-region-cost<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>define-key map <span style="color: #458588;">[</span><span style="color: #b16286;">(</span>control c<span style="color: #b16286;">)(</span>p<span style="color: #b16286;">)</span><span style="color: #458588;">]</span> #'beancount-insert-prices<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    map<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-mode-syntax-table</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>st <span style="color: #458588;">(</span>make-syntax-table<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>modify-syntax-entry ?\" <span style="color: #79740e;">"\"\""</span> st<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>modify-syntax-entry ?\; <span style="color: #79740e;">"&lt;"</span> st<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>modify-syntax-entry ?\n <span style="color: #79740e;">"&gt;"</span> st<span style="color: #8ec07c;">)</span>
    st<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;;;</span><span style="color: #a89984;">###</span><span style="color: #9d0006; font-weight: bold;">autoload</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">define-derived-mode</span> <span style="color: #b57614;">beancount-mode</span> prog-mode <span style="color: #79740e;">"Beancount"</span>
  <span style="color: #79740e;">"A mode for Beancount files.</span>

<span style="color: #79740e;">\\{</span><span style="color: #076678;">beancount-mode-ma</span><span style="color: #79740e;">p}"</span>
  <span style="color: #af3a03;">:group</span> 'beancount
  <span style="color: #af3a03;">:syntax-table</span> beancount-mode-syntax-table

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> paragraph-ignore-fill-prefix t<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> fill-paragraph-function #'beancount-indent-transaction<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> comment-start <span style="color: #79740e;">";"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> comment-start-skip <span style="color: #79740e;">";+\\s-*"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> comment-add 1<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> indent-line-function #'beancount-indent-line<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> indent-region-function #'beancount-indent-region<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> indent-tabs-mode nil<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> tab-always-indent 'complete<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> completion-ignore-case t<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span>add-hook 'completion-at-point-functions #'beancount-completion-at-point nil t<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>add-hook 'post-command-hook #'beancount-highlight-transaction-at-point nil t<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>add-hook 'post-self-insert-hook #'beancount--electric-currency nil t<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> font-lock-defaults '<span style="color: #8ec07c;">(</span>beancount-font-lock-keywords<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> font-lock-syntax-table t<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> outline-regexp beancount-outline-regexp<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> outline-level #'beancount-outline-level<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq-local</span> xref-backend-functions #'beancount-xref-backend<span style="color: #b16286;">)</span>

  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> imenu-generic-expression
    <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>list nil <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"^"</span> beancount-outline-regexp <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">.*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">$"</span><span style="color: #458588;">)</span> 2<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-collect-pushed-tags</span> <span style="color: #b16286;">(</span>begin end<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Return list of all pushed (and not popped) tags in the region."</span>
  <span style="color: #b16286;">(</span>goto-char begin<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>tags <span style="color: #458588;">(</span>make-hash-table <span style="color: #af3a03;">:test</span> 'equal<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">while</span> <span style="color: #d65d0e;">(</span>re-search-forward
         <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">push</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">|</span><span style="color: #79740e;">pop</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">tag\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">#["</span> beancount-tag-chars <span style="color: #79740e;">"]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span> end t<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> <span style="color: #458588;">(</span>string-equal <span style="color: #b16286;">(</span>match-string 1<span style="color: #b16286;">)</span> <span style="color: #79740e;">"push"</span><span style="color: #458588;">)</span>
          <span style="color: #458588;">(</span>puthash <span style="color: #b16286;">(</span>match-string-no-properties 2<span style="color: #b16286;">)</span> nil tags<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>remhash <span style="color: #b16286;">(</span>match-string-no-properties 2<span style="color: #b16286;">)</span> tags<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>hash-table-keys tags<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-goto-transaction-begin</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Move the cursor to the first line of the transaction definition."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beginning-of-line<span style="color: #b16286;">)</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">everything that is indented with at lest one space or tab is part</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">of the transaction definition</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span>looking-at-p <span style="color: #79740e;">"[ \t]+"</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>forward-line -1<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-goto-transaction-end</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Move the cursor to the line after the transaction definition."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beginning-of-line<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>looking-at-p beancount-transaction-regexp<span style="color: #8ec07c;">)</span>
      <span style="color: #8ec07c;">(</span>forward-line<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">everything that is indented with at least one space or tab as part</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">of the transaction definition</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span>looking-at-p <span style="color: #79740e;">"[ \t]+"</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>forward-line<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-goto-next-transaction</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Move to the next transaction.</span>
<span style="color: #79740e;">With an argument move to the next non cleared transaction."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-goto-transaction-end<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>done nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">while</span> <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">and</span> <span style="color: #458588;">(</span>not done<span style="color: #458588;">)</span>
                <span style="color: #458588;">(</span>re-search-forward beancount-transaction-regexp nil t<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> <span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> arg <span style="color: #b16286;">(</span>string-equal <span style="color: #8ec07c;">(</span>match-string 2<span style="color: #8ec07c;">)</span> <span style="color: #79740e;">"*"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
          <span style="color: #458588;">(</span>goto-char <span style="color: #b16286;">(</span>match-end 0<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>goto-char <span style="color: #b16286;">(</span>match-beginning 0<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> done t<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>not done<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>goto-char <span style="color: #458588;">(</span>point-max<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-goto-previous-transaction</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Move to the previous transaction.</span>
<span style="color: #79740e;">With an argument move to the previous non cleared transaction."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-goto-transaction-begin<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>done nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">while</span> <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">and</span> <span style="color: #458588;">(</span>not done<span style="color: #458588;">)</span>
                <span style="color: #458588;">(</span>re-search-backward beancount-transaction-regexp nil t<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> <span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> arg <span style="color: #b16286;">(</span>string-equal <span style="color: #8ec07c;">(</span>match-string 2<span style="color: #8ec07c;">)</span> <span style="color: #79740e;">"*"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
          <span style="color: #458588;">(</span>goto-char <span style="color: #b16286;">(</span>match-beginning 0<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>goto-char <span style="color: #b16286;">(</span>match-beginning 0<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> done t<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>not done<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>goto-char <span style="color: #458588;">(</span>point-min<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-find-transaction-extents</span> <span style="color: #b16286;">(</span>p<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span>goto-char p<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>beancount-goto-transaction-begin<span style="color: #d65d0e;">)</span>
          <span style="color: #d65d0e;">(</span>beancount-goto-transaction-end<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-inside-transaction-p</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>bounds <span style="color: #458588;">(</span>beancount-find-transaction-extents <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>&gt; <span style="color: #d65d0e;">(</span>- <span style="color: #458588;">(</span>cadr bounds<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>car bounds<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span> 0<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-looking-at</span> <span style="color: #b16286;">(</span>regexp n pos<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">and</span> <span style="color: #8ec07c;">(</span>looking-at regexp<span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span>&gt;= pos <span style="color: #d65d0e;">(</span>match-beginning n<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
       <span style="color: #8ec07c;">(</span>&lt;= pos <span style="color: #d65d0e;">(</span>match-end n<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-accounts</span> nil
  <span style="color: #79740e;">"A list of the accounts available in this buffer."</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span>make-variable-buffer-local 'beancount-accounts<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-completion-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Return the completion data relevant for the text at point."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-match-data</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>pos <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>beginning-of-line<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">cond</span>
         <span style="color: #a89984;">;; </span><span style="color: #a89984;">non timestamped directive</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at <span style="color: #79740e;">"[a-z]*"</span> 0 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 0<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 0<span style="color: #d65d0e;">)</span>
                <span style="color: #d65d0e;">(</span>mapcar <span style="color: #458588;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #458588;">(</span>s<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>concat s <span style="color: #79740e;">" "</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span> beancount-directive-names<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">poptag</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"poptag\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(?:</span><span style="color: #79740e;">#["</span> beancount-tag-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> 1 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span>
                <span style="color: #d65d0e;">(</span>beancount-collect-pushed-tags <span style="color: #458588;">(</span>point-min<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>point<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">option</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"^option\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">\"[a-z_]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> 1 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span>
                <span style="color: #d65d0e;">(</span>mapcar <span style="color: #458588;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #458588;">(</span>s<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"\""</span> s <span style="color: #79740e;">"\" "</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span> beancount-option-names<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">timestamped directive</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat beancount-date-regexp <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[[:alpha:]]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> 1 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span>
                <span style="color: #d65d0e;">(</span>mapcar <span style="color: #458588;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #458588;">(</span>s<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>concat s <span style="color: #79740e;">" "</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span> beancount-timestamped-directive-names<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">timestamped directives followed by account</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"^"</span> beancount-date-regexp
                   <span style="color: #79740e;">"\\s-+"</span> <span style="color: #458588;">(</span>regexp-opt beancount-account-directive-names<span style="color: #458588;">)</span>
                   <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-account-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> <span style="color: #9d0006; font-weight: bold;">1 pos</span><span style="color: #8ec07c; font-weight: bold;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> beancount-accounts nil<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span> #'beancount-account-completion-table<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">pad directive followed by two accounts</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"^"</span> beancount-date-regexp
                   <span style="color: #79740e;">"\\s-+"</span> <span style="color: #458588;">(</span>regexp-opt '<span style="color: #458588;">(</span><span style="color: #79740e;">"pad"</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span>
                   <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-account-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                   <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-account-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> <span style="color: #9d0006; font-weight: bold;">2 pos</span><span style="color: #8ec07c; font-weight: bold;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> beancount-accounts nil<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 2<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 2<span style="color: #d65d0e;">)</span> #'beancount-account-completion-table<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">posting</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> <span style="color: #d65d0e;">(</span>beancount-looking-at
                <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"[ \t]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-account-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span> 1 pos<span style="color: #d65d0e;">)</span>
               <span style="color: #a89984;">;; </span><span style="color: #a89984;">Do not force the account name to start with a</span>
               <span style="color: #a89984;">;; </span><span style="color: #a89984;">capital, so that it is possible to use substring</span>
               <span style="color: #a89984;">;; </span><span style="color: #a89984;">completion and we can rely on completion to fix</span>
               <span style="color: #a89984;">;; </span><span style="color: #a89984;">capitalization thanks to completion-ignore-case.</span>
               <span style="color: #d65d0e;">(</span>beancount-inside-transaction-p<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> beancount-accounts nil<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span>list <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span> #'beancount-account-completion-table<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">tags</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"[ \t]+#</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-tag-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> 1 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>candidates nil<span style="color: #458588;">)</span>
                 <span style="color: #458588;">(</span>regexp <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"\\#</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-tag-chars <span style="color: #79740e;">"]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span>
                 <span style="color: #458588;">(</span>completion-table
                  <span style="color: #458588;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #b16286;">(</span>string pred action<span style="color: #b16286;">)</span>
                    <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>null candidates<span style="color: #8ec07c;">)</span>
                        <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> candidates
                              <span style="color: #d65d0e;">(</span>sort <span style="color: #458588;">(</span>beancount-collect-unique regexp 1<span style="color: #458588;">)</span> #'string&lt;<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                    <span style="color: #b16286;">(</span>complete-with-action action candidates string pred<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
            <span style="color: #d65d0e;">(</span>list <span style="color: #458588;">(</span>match-beginning 1<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>match-end 1<span style="color: #458588;">)</span> completion-table<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

         <span style="color: #a89984;">;; </span><span style="color: #a89984;">links</span>
         <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-looking-at
           <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"[ \t]+\\^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-tag-chars <span style="color: #79740e;">"]*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #d65d0e;">)</span> 1 pos<span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>candidates nil<span style="color: #458588;">)</span>
                 <span style="color: #458588;">(</span>regexp <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"\\^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">["</span> beancount-tag-chars <span style="color: #79740e;">"]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span>
                 <span style="color: #458588;">(</span>completion-table
                  <span style="color: #458588;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #b16286;">(</span>string pred action<span style="color: #b16286;">)</span>
                    <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>null candidates<span style="color: #8ec07c;">)</span>
                        <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> candidates
                              <span style="color: #d65d0e;">(</span>sort <span style="color: #458588;">(</span>beancount-collect-unique regexp 1<span style="color: #458588;">)</span> #'string&lt;<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                    <span style="color: #b16286;">(</span>complete-with-action action candidates string pred<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
            <span style="color: #d65d0e;">(</span>list <span style="color: #458588;">(</span>match-beginning 1<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>match-end 1<span style="color: #458588;">)</span> completion-table<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-account-files</span> nil
  <span style="color: #79740e;">"List of account files"</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-collect-pos-alist</span> <span style="color: #b16286;">(</span>regexp n<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Return a list of conses mapping matches of REGEXP group N in the</span>
<span style="color: #79740e;">current buffer to a position of the match beginning."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>result<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">collect accounts from files</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">dolist</span> <span style="color: #458588;">(</span>f beancount-account-files<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">with-current-buffer</span> <span style="color: #b16286;">(</span>find-file-noselect f<span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>goto-char <span style="color: #8ec07c;">(</span>point-min<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span>re-search-forward regexp nil t<span style="color: #8ec07c;">)</span>
            <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">push</span> <span style="color: #d65d0e;">(</span>cons <span style="color: #458588;">(</span>match-string-no-properties n<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>match-beginning 0<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
                  result<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>nreverse result<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-get-account-names</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Return a list of known account names available in the buffer."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span>null beancount-accounts<span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Collecting a full list and then deduping it is a heavy</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">operation. But because of caching the will only happen once -</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">whenever a completion is requested.</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> beancount-accounts
      <span style="color: #d65d0e;">(</span>sort <span style="color: #458588;">(</span>beancount-collect-unique beancount-account-regexp 0<span style="color: #458588;">)</span> #'string&lt;<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  beancount-accounts<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-collect-unique</span> <span style="color: #b16286;">(</span>regexp n<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Return an unique list of REGEXP group N in the current buffer."</span>
  <span style="color: #b16286;">(</span>delete-dups <span style="color: #8ec07c;">(</span>mapcar #'car <span style="color: #d65d0e;">(</span>beancount-collect-pos-alist regexp n<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-account-completion-table</span> <span style="color: #b16286;">(</span>string pred action<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>eq action 'metadata<span style="color: #8ec07c;">)</span> '<span style="color: #8ec07c;">(</span>metadata <span style="color: #d65d0e;">(</span>category . beancount-account<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">with-current-buffer</span> <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>win <span style="color: #8ec07c;">(</span>minibuffer-selected-window<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                           <span style="color: #458588;">(</span><span style="color: #9d0006;">if</span> <span style="color: #b16286;">(</span>window-live-p win<span style="color: #b16286;">)</span> <span style="color: #b16286;">(</span>window-buffer win<span style="color: #b16286;">)</span>
                             <span style="color: #b16286;">(</span>current-buffer<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>complete-with-action action <span style="color: #458588;">(</span>beancount-get-account-names<span style="color: #458588;">)</span> string pred<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">Default to substring completion for beancount accounts.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defconst</span> <span style="color: #076678;">beancount--completion-overrides</span>
  '<span style="color: #b16286;">(</span>beancount-account <span style="color: #8ec07c;">(</span>styles basic partial-completion substring<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span>add-to-list 'completion-category-defaults beancount--completion-overrides<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-number-alignment-column</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Return the column to which postings amounts should be aligned to.</span>
<span style="color: #79740e;">Returns `</span><span style="color: #8f3f71;">beancount-number-alignment-column</span><span style="color: #79740e;">' unless it is 0. In</span>
<span style="color: #79740e;">that case, scan the buffer to determine the minimum column that</span>
<span style="color: #79740e;">will allow to align all numbers."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>&gt; beancount-number-alignment-column 0<span style="color: #8ec07c;">)</span>
      beancount-number-alignment-column
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">save-match-data</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">let</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>account-width 0<span style="color: #8ec07c;">)</span>
              <span style="color: #8ec07c;">(</span>number-width 0<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>goto-char <span style="color: #8ec07c;">(</span>point-min<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span>re-search-forward beancount-posting-regexp nil t<span style="color: #8ec07c;">)</span>
            <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>match-string 2<span style="color: #d65d0e;">)</span>
                <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #458588;">(</span>accw <span style="color: #b16286;">(</span>- <span style="color: #8ec07c;">(</span>match-end 1<span style="color: #8ec07c;">)</span> <span style="color: #8ec07c;">(</span>line-beginning-position<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                      <span style="color: #458588;">(</span>numw <span style="color: #b16286;">(</span>- <span style="color: #8ec07c;">(</span>match-end 3<span style="color: #8ec07c;">)</span> <span style="color: #8ec07c;">(</span>match-beginning 3<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span>
                  <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> account-width <span style="color: #458588;">(</span>max account-width accw<span style="color: #458588;">)</span>
                        number-width <span style="color: #458588;">(</span>max number-width numw<span style="color: #458588;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>+ account-width 2 number-width<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-compute-indentation</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Return the column to which the current line should be indented."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span>beginning-of-line<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cond</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">Only timestamped directives start with a digit.</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>looking-at-p <span style="color: #79740e;">"[0-9]"</span><span style="color: #458588;">)</span> 0<span style="color: #d65d0e;">)</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">Otherwise look at the previous line.</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> <span style="color: #b16286;">(</span>= <span style="color: #8ec07c;">(</span>forward-line -1<span style="color: #8ec07c;">)</span> 0<span style="color: #b16286;">)</span>
           <span style="color: #b16286;">(</span><span style="color: #9d0006;">or</span> <span style="color: #8ec07c;">(</span>looking-at-p <span style="color: #79740e;">"[ \t].+"</span><span style="color: #8ec07c;">)</span>
               <span style="color: #8ec07c;">(</span>looking-at-p beancount-timestamped-directive-regexp<span style="color: #8ec07c;">)</span>
               <span style="color: #8ec07c;">(</span>looking-at-p beancount-transaction-regexp<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      beancount-transaction-indent<span style="color: #d65d0e;">)</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">Default.</span>
     <span style="color: #d65d0e;">(</span>t 0<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-align-number</span> <span style="color: #b16286;">(</span>target-column<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span>beginning-of-line<span style="color: #8ec07c;">)</span>
    <span style="color: #a89984;">;; </span><span style="color: #a89984;">Check if the current line is a posting with a number to align.</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">when</span> <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">and</span> <span style="color: #458588;">(</span><span style="color: #9d0006;">or</span> <span style="color: #b16286;">(</span>looking-at beancount-posting-regexp<span style="color: #b16286;">)</span>
                   <span style="color: #b16286;">(</span>looking-at beancount-balance-regexp<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                   <span style="color: #458588;">(</span>match-string 2<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>account-end-column <span style="color: #8ec07c;">(</span>- <span style="color: #d65d0e;">(</span>match-end 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>line-beginning-position<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>number-width <span style="color: #8ec07c;">(</span>- <span style="color: #d65d0e;">(</span>match-end 3<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-beginning 3<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>account-end <span style="color: #8ec07c;">(</span>match-end 1<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>number-beginning <span style="color: #8ec07c;">(</span>match-beginning 3<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>spaces <span style="color: #8ec07c;">(</span>max 2 <span style="color: #d65d0e;">(</span>- target-column account-end-column number-width<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">unless</span> <span style="color: #b16286;">(</span>eq spaces <span style="color: #8ec07c;">(</span>- number-beginning account-end<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>goto-char account-end<span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>delete-region account-end number-beginning<span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>insert <span style="color: #8ec07c;">(</span>make-string spaces ? <span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-indent-line</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>indent <span style="color: #458588;">(</span>beancount-compute-indentation<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>savep <span style="color: #458588;">(</span>&gt; <span style="color: #b16286;">(</span>current-column<span style="color: #b16286;">)</span> <span style="color: #b16286;">(</span>current-indentation<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">unless</span> <span style="color: #d65d0e;">(</span>eq indent <span style="color: #458588;">(</span>current-indentation<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> savep <span style="color: #458588;">(</span><span style="color: #9d0006;">save-excursion</span> <span style="color: #b16286;">(</span>indent-line-to indent<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>indent-line-to indent<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beancount-align-number <span style="color: #d65d0e;">(</span>beancount-number-alignment-column<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-indent-region</span> <span style="color: #b16286;">(</span>start end<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Indent a region automagically. START and END specify the region to indent."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>deactivate-mark nil<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>beancount-number-alignment-column <span style="color: #458588;">(</span>beancount-number-alignment-column<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">setq</span> end <span style="color: #458588;">(</span>copy-marker end<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>goto-char start<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> <span style="color: #458588;">(</span>bolp<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>forward-line 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">while</span> <span style="color: #458588;">(</span>&lt; <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span> end<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">unless</span> <span style="color: #b16286;">(</span>looking-at-p <span style="color: #79740e;">"\\s-*$"</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>beancount-indent-line<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>forward-line 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>move-marker end nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-indent-transaction</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> _justify _region<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Indent Beancount transaction at point."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>bounds <span style="color: #b16286;">(</span>beancount-find-transaction-extents <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>beancount-indent-region <span style="color: #458588;">(</span>car bounds<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>cadr bounds<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-transaction-clear</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Clear transaction at point. With a prefix argument set the</span>
<span style="color: #79740e;">transaction as pending."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-match-data</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>flag <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> arg <span style="color: #79740e;">"!"</span> <span style="color: #79740e;">"*"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>beancount-goto-transaction-begin<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">if</span> <span style="color: #b16286;">(</span>looking-at beancount-transaction-regexp<span style="color: #b16286;">)</span>
            <span style="color: #b16286;">(</span>replace-match flag t t nil 2<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-insert-account</span> <span style="color: #b16286;">(</span>account-name<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Insert one of the valid account names in this file.</span>
<span style="color: #79740e;">Uses ido niceness according to `</span><span style="color: #8f3f71;">beancount-use-ido</span><span style="color: #79740e;">'."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span>
   <span style="color: #8ec07c;">(</span>list
    <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> beancount-use-ido
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">`</span><span style="color: #8f3f71;">ido-completing-read</span><span style="color: #a89984;">' does not understand functional</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">completion tables thus directly build a list of the</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">accounts in the buffer</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">let</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>beancount-accounts
               <span style="color: #d65d0e;">(</span>sort <span style="color: #458588;">(</span>beancount-collect-unique beancount-account-regexp 0<span style="color: #458588;">)</span> #'string&lt;<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>ido-completing-read <span style="color: #79740e;">"Account: "</span> beancount-accounts
                               nil nil <span style="color: #8ec07c;">(</span>thing-at-point 'word<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>completing-read <span style="color: #79740e;">"Account: "</span> #'beancount-account-completion-table
                       nil t <span style="color: #b16286;">(</span>thing-at-point 'word<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>bounds <span style="color: #458588;">(</span>bounds-of-thing-at-point 'word<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">when</span> bounds
      <span style="color: #d65d0e;">(</span>delete-region <span style="color: #458588;">(</span>car bounds<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>cdr bounds<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>insert account-name<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defmacro</span> <span style="color: #b57614;">beancount-for-line-in-region</span> <span style="color: #b16286;">(</span>begin end <span style="color: #8f3f71;">&amp;rest</span> exprs<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Iterate over each line in region until an empty line is encountered."</span>
  `<span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
     <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>end-marker <span style="color: #b16286;">(</span>copy-marker ,end<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
       <span style="color: #d65d0e;">(</span>goto-char ,begin<span style="color: #d65d0e;">)</span>
       <span style="color: #d65d0e;">(</span>beginning-of-line<span style="color: #d65d0e;">)</span>
       <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">while</span> <span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> <span style="color: #b16286;">(</span>not <span style="color: #8ec07c;">(</span>eobp<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span> <span style="color: #b16286;">(</span>&lt; <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span> end-marker<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
         <span style="color: #458588;">(</span>beginning-of-line<span style="color: #458588;">)</span>
         <span style="color: #458588;">(</span><span style="color: #9d0006;">progn</span> ,@exprs<span style="color: #458588;">)</span>
         <span style="color: #458588;">(</span>forward-line 1<span style="color: #458588;">)</span>
         <span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-align-numbers</span> <span style="color: #b16286;">(</span>begin end <span style="color: #8f3f71;">&amp;optional</span> requested-currency-column<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Align all numbers in the given region. CURRENCY-COLUMN is the character</span>
<span style="color: #79740e;">at which to align the beginning of the amount's currency. If not specified, use</span>
<span style="color: #79740e;">the smallest columns that will align all the numbers.  With a prefix argument,</span>
<span style="color: #79740e;">align with the fill-column."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"r"</span><span style="color: #b16286;">)</span>

  <span style="color: #a89984;">;; </span><span style="color: #a89984;">With a prefix argument, align with the fill-column.</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> current-prefix-arg
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> requested-currency-column fill-column<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>

  <span style="color: #a89984;">;; </span><span style="color: #a89984;">Loop once in the region to find the length of the longest string before the</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">number.</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span>prefix-widths
        number-widths
        <span style="color: #d65d0e;">(</span>number-padding <span style="color: #79740e;">"  "</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">beancount-for-line-in-region</span>
     begin end
     <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>line <span style="color: #8ec07c;">(</span>thing-at-point 'line<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
       <span style="color: #458588;">(</span><span style="color: #9d0006;">when</span> <span style="color: #b16286;">(</span>string-match <span style="color: #8ec07c;">(</span>concat <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">.*?</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                                   <span style="color: #79740e;">"[ \t]+"</span>
                                   <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-number-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                                   <span style="color: #79740e;">"[ \t]+"</span>
                                   beancount-currency-regexp<span style="color: #8ec07c;">)</span>
                           line<span style="color: #b16286;">)</span>
         <span style="color: #b16286;">(</span><span style="color: #9d0006;">push</span> <span style="color: #8ec07c;">(</span>length <span style="color: #d65d0e;">(</span>match-string 1 line<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> prefix-widths<span style="color: #b16286;">)</span>
         <span style="color: #b16286;">(</span><span style="color: #9d0006;">push</span> <span style="color: #8ec07c;">(</span>length <span style="color: #d65d0e;">(</span>match-string 2 line<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> number-widths<span style="color: #b16286;">)</span>
         <span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>

    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">when</span> prefix-widths
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Loop again to make the adjustments to the numbers.</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>number-width <span style="color: #8ec07c;">(</span>apply 'max number-widths<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>number-format <span style="color: #8ec07c;">(</span>format <span style="color: #79740e;">"%%%ss"</span> number-width<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #a89984;">;; </span><span style="color: #a89984;">Compute rightmost column of prefix.</span>
             <span style="color: #b16286;">(</span>max-prefix-width <span style="color: #8ec07c;">(</span>apply 'max prefix-widths<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>max-prefix-width
              <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> requested-currency-column
                  <span style="color: #d65d0e;">(</span>max <span style="color: #458588;">(</span>- requested-currency-column <span style="color: #458588;">(</span>length number-padding<span style="color: #458588;">)</span> number-width 1<span style="color: #458588;">)</span>
                       max-prefix-width<span style="color: #d65d0e;">)</span>
                max-prefix-width<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #b16286;">(</span>prefix-format <span style="color: #8ec07c;">(</span>format <span style="color: #79740e;">"%%-%ss"</span> max-prefix-width<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
             <span style="color: #458588;">)</span>

        <span style="color: #458588;">(</span><span style="color: #9d0006;">beancount-for-line-in-region</span>
         begin end
         <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>line <span style="color: #458588;">(</span>thing-at-point 'line<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
           <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">when</span> <span style="color: #d65d0e;">(</span>string-match <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"^</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[</span><span style="color: #79740e;">^</span><span style="color: #79740e;">\"]*?</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                                       <span style="color: #79740e;">"[ \t]+"</span>
                                       <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-number-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                                       <span style="color: #79740e;">"[ \t]+"</span>
                                       <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">.*</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">$"</span><span style="color: #458588;">)</span>
                               line<span style="color: #d65d0e;">)</span>
             <span style="color: #d65d0e;">(</span>delete-region <span style="color: #458588;">(</span>line-beginning-position<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>line-end-position<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
             <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #458588;">(</span><span style="color: #458588;">(</span>prefix <span style="color: #b16286;">(</span>match-string 1 line<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                    <span style="color: #458588;">(</span>number <span style="color: #b16286;">(</span>match-string 2 line<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                    <span style="color: #458588;">(</span>rest <span style="color: #b16286;">(</span>match-string 3 line<span style="color: #b16286;">)</span><span style="color: #458588;">)</span> <span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>insert <span style="color: #458588;">(</span>format prefix-format prefix<span style="color: #458588;">)</span><span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>insert number-padding<span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>insert <span style="color: #458588;">(</span>format number-format number<span style="color: #458588;">)</span><span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>insert <span style="color: #79740e;">" "</span><span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>insert rest<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-align-to-previous-number</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Align postings under the point's paragraph.</span>
<span style="color: #79740e;">This function looks for a posting in the previous transaction to</span>
<span style="color: #79740e;">determine the column at which to align the transaction, or otherwise</span>
<span style="color: #79740e;">the fill column, and align all the postings of this transaction to</span>
<span style="color: #79740e;">this column."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>begin <span style="color: #458588;">(</span><span style="color: #9d0006;">save-excursion</span>
                  <span style="color: #b16286;">(</span>beancount-beginning-of-directive<span style="color: #b16286;">)</span>
                  <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
         <span style="color: #d65d0e;">(</span>end <span style="color: #458588;">(</span><span style="color: #9d0006;">save-excursion</span>
                <span style="color: #b16286;">(</span>goto-char begin<span style="color: #b16286;">)</span>
                <span style="color: #b16286;">(</span>forward-paragraph 1<span style="color: #b16286;">)</span>
                <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
         <span style="color: #d65d0e;">(</span>currency-column <span style="color: #458588;">(</span><span style="color: #9d0006;">or</span> <span style="color: #b16286;">(</span>beancount-find-previous-alignment-column<span style="color: #b16286;">)</span>
                              fill-column<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beancount-align-numbers begin end currency-column<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>


<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-beginning-of-directive</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Move point to the beginning of the enclosed or preceding directive."</span>
  <span style="color: #b16286;">(</span>beginning-of-line<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> <span style="color: #d65d0e;">(</span>&gt; <span style="color: #458588;">(</span>point<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>point-min<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span>not <span style="color: #458588;">(</span>looking-at
                      <span style="color: #79740e;">"[0-9][0-9][0-9][0-9][</span><span style="color: #9d0006; font-weight: bold;">\</span><span style="color: #79740e;">-/][0-9][0-9][</span><span style="color: #9d0006; font-weight: bold;">\</span><span style="color: #79740e;">-/][0-9][0-9]"</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>forward-line -1<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>


<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-find-previous-alignment-column</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Find the preceding column to align amounts with.</span>
<span style="color: #79740e;">This is used to align transactions at the same column as that of</span>
<span style="color: #79740e;">the previous transaction in the file. This function merely finds</span>
<span style="color: #79740e;">what that column is and returns it (an integer)."</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">Go hunting for the last column with a suitable posting.</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span>column<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Go to the beginning of the enclosing directive.</span>
      <span style="color: #d65d0e;">(</span>beancount-beginning-of-directive<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>forward-line -1<span style="color: #d65d0e;">)</span>

      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Find the last posting with an amount and a currency on it.</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>posting-regexp <span style="color: #8ec07c;">(</span>concat
                             <span style="color: #79740e;">"\\s-+"</span>
                             beancount-account-regexp <span style="color: #79740e;">"\\s-+"</span>
                             beancount-number-regexp <span style="color: #79740e;">"\\s-+"</span>
                             <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-currency-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
            <span style="color: #b16286;">(</span>balance-regexp <span style="color: #8ec07c;">(</span>concat
                             beancount-date-regexp <span style="color: #79740e;">"\\s-+"</span>
                             <span style="color: #79740e;">"balance"</span> <span style="color: #79740e;">"\\s-+"</span>
                             beancount-account-regexp <span style="color: #79740e;">"\\s-+"</span>
                             beancount-number-regexp <span style="color: #79740e;">"\\s-+"</span>
                             <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-currency-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">while</span> <span style="color: #b16286;">(</span><span style="color: #9d0006;">and</span> <span style="color: #8ec07c;">(</span>&gt; <span style="color: #d65d0e;">(</span>point<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>point-min<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
                    <span style="color: #8ec07c;">(</span>not <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> <span style="color: #458588;">(</span>looking-at posting-regexp<span style="color: #458588;">)</span>
                             <span style="color: #458588;">(</span>looking-at balance-regexp<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span>forward-line -1<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">when</span> <span style="color: #b16286;">(</span><span style="color: #9d0006;">or</span> <span style="color: #8ec07c;">(</span>looking-at posting-regexp<span style="color: #8ec07c;">)</span>
                  <span style="color: #8ec07c;">(</span>looking-at balance-regexp<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> column <span style="color: #8ec07c;">(</span>- <span style="color: #d65d0e;">(</span>match-beginning 1<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>point<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    column<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--account-currency</span> <span style="color: #b16286;">(</span>account<span style="color: #b16286;">)</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">Build a regexp that matches an open directive that specifies a</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">single account currencydaaee. The currency is match group 1.</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>re <span style="color: #458588;">(</span>concat <span style="color: #79740e;">"^"</span> beancount-date-regexp <span style="color: #79740e;">" +open"</span>
                    <span style="color: #79740e;">"\\s-+"</span> <span style="color: #b16286;">(</span>regexp-quote account<span style="color: #b16286;">)</span>
                    <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-currency-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\s-+"</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #d65d0e;">(</span>goto-char <span style="color: #458588;">(</span>point-min<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">when</span> <span style="color: #458588;">(</span>re-search-forward re nil t<span style="color: #458588;">)</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">The account has declared a single currency, so we can fill it in.</span>
        <span style="color: #458588;">(</span>match-string-no-properties 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--electric-currency</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> beancount-electric-currency <span style="color: #d65d0e;">(</span>eq last-command-event ?\n<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
      <span style="color: #d65d0e;">(</span>forward-line -1<span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">when</span> <span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> <span style="color: #b16286;">(</span>beancount-inside-transaction-p<span style="color: #b16286;">)</span>
                 <span style="color: #b16286;">(</span>looking-at <span style="color: #8ec07c;">(</span>concat <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-account-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">"</span>
                                     <span style="color: #79740e;">"\\s-+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">"</span> beancount-number-regexp <span style="color: #79740e;">"</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\s-*$"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">Last line is a posting without currency.</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>account <span style="color: #d65d0e;">(</span>match-string 1<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
               <span style="color: #8ec07c;">(</span>pos <span style="color: #d65d0e;">(</span>match-end 0<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
               <span style="color: #8ec07c;">(</span>currency <span style="color: #d65d0e;">(</span>beancount--account-currency account<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
          <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> currency
            <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span>
          <span style="color: #d65d0e;">(</span>goto-char pos<span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span>insert <span style="color: #79740e;">" "</span> currency<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defmacro</span> <span style="color: #b57614;">beancount--encode-time</span> <span style="color: #b16286;">(</span>time<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Compatibility helper.</span>
<span style="color: #79740e;">Impedence match the `</span><span style="color: #8f3f71;">encode-time</span><span style="color: #79740e;">' interface between Emacs-26 and</span>
<span style="color: #79740e;">later Emacs releases. It can be eliminated once support for</span>
<span style="color: #79740e;">Emacs-26 is dropped."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>version&lt; emacs-version <span style="color: #79740e;">"27.1"</span><span style="color: #8ec07c;">)</span>
      `<span style="color: #8ec07c;">(</span>apply #'encode-time ,time<span style="color: #8ec07c;">)</span>
    `<span style="color: #8ec07c;">(</span>encode-time ,time<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--parse-date</span> <span style="color: #b16286;">(</span>string<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Parse the STRING date in the format %Y-%m-%d into a Lisp timestamp."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-match-data</span>
    <span style="color: #8ec07c;">(</span>string-match <span style="color: #79740e;">"\\`</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[0-9][0-9][0-9][0-9]</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">-</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[0-9][0-9]</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">-</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">[0-9][0-9]</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\\'"</span> string<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">beancount--encode-time</span> <span style="color: #d65d0e;">(</span>list 0 0 0
                                  <span style="color: #458588;">(</span>string-to-number <span style="color: #b16286;">(</span>match-string 3 string<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                                  <span style="color: #458588;">(</span>string-to-number <span style="color: #b16286;">(</span>match-string 2 string<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                                  <span style="color: #458588;">(</span>string-to-number <span style="color: #b16286;">(</span>match-string 1 string<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
                                  nil -1 nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--format-date</span> <span style="color: #b16286;">(</span>time<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Format the Lisp timestamp TIME into a date in the format %Y-%m-%d."</span>
  <span style="color: #b16286;">(</span>format-time-string <span style="color: #79740e;">"%Y-%m-%d"</span> time<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-insert-date</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> days<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Start a new timestamped directive with date DAYS before today."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">unless</span> <span style="color: #8ec07c;">(</span>bolp<span style="color: #8ec07c;">)</span> <span style="color: #8ec07c;">(</span>newline<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>insert <span style="color: #8ec07c;">(</span>beancount--format-date <span style="color: #d65d0e;">(</span>time-add <span style="color: #458588;">(</span>current-time<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>days-to-time <span style="color: #b16286;">(</span>- <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">or</span> days 0<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--shift-date-at-point</span> <span style="color: #b16286;">(</span>days<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Shift the date under point by a specified number of DAYS."</span>
    <span style="color: #b16286;">(</span><span style="color: #9d0006;">if</span> <span style="color: #8ec07c;">(</span>thing-at-point-looking-at beancount-date-regexp 10<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>pos <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
              <span style="color: #458588;">(</span>date <span style="color: #b16286;">(</span>beancount--parse-date <span style="color: #8ec07c;">(</span>match-string 0<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
          <span style="color: #d65d0e;">(</span>replace-match <span style="color: #458588;">(</span>beancount--format-date <span style="color: #b16286;">(</span>time-add date <span style="color: #8ec07c;">(</span>days-to-time days<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span> t t<span style="color: #d65d0e;">)</span>
          <span style="color: #a89984;">;; </span><span style="color: #a89984;">Ensure that point stays in the same position.</span>
          <span style="color: #d65d0e;">(</span>goto-char pos<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006; font-weight: bold;">user-error</span> <span style="color: #79740e;">"No date at point"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-date-up-day</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> days<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Increase the date in the current line by one day.</span>
<span style="color: #79740e;">With prefix ARG, change that many days."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"p"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount--shift-date-at-point <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">or</span> days 1<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-date-down-day</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> days<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Decrease the date in the current line by one day.</span>
<span style="color: #79740e;">With prefix ARG, change that many days."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"p"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount--shift-date-at-point <span style="color: #8ec07c;">(</span>- <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> days 1<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-install-dir</span> nil
  <span style="color: #79740e;">"Directory in which Beancount's source is located.</span>
<span style="color: #79740e;">Only useful if you have not installed Beancount properly in your PATH."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-check-program</span> <span style="color: #79740e;">"bean-check"</span>
  <span style="color: #79740e;">"Program to run to run just the parser and validator on an</span>
<span style="color: #79740e;">  input file."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">compilation-read-command</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--run</span> <span style="color: #b16286;">(</span>prog <span style="color: #8f3f71;">&amp;rest</span> args<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>process-environment
         <span style="color: #458588;">(</span><span style="color: #9d0006;">if</span> beancount-install-dir
             `<span style="color: #b16286;">(</span>,<span style="color: #8ec07c;">(</span>concat <span style="color: #79740e;">"PYTHONPATH="</span> beancount-install-dir<span style="color: #8ec07c;">)</span>
               ,<span style="color: #8ec07c;">(</span>concat <span style="color: #79740e;">"PATH="</span>
                        <span style="color: #d65d0e;">(</span>expand-file-name <span style="color: #79740e;">"bin"</span> beancount-install-dir<span style="color: #d65d0e;">)</span>
                        <span style="color: #79740e;">":"</span>
                        <span style="color: #d65d0e;">(</span>getenv <span style="color: #79740e;">"PATH"</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
               ,@process-environment<span style="color: #b16286;">)</span>
           process-environment<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>compile-command <span style="color: #458588;">(</span>mapconcat <span style="color: #b16286;">(</span><span style="color: #9d0006;">lambda</span> <span style="color: #8ec07c;">(</span>arg<span style="color: #8ec07c;">)</span>
                                      <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>stringp arg<span style="color: #d65d0e;">)</span>
                                          <span style="color: #d65d0e;">(</span>shell-quote-argument arg<span style="color: #d65d0e;">)</span> <span style="color: #79740e;">""</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                                    <span style="color: #b16286;">(</span>cons prog args<span style="color: #b16286;">)</span>
                                    <span style="color: #79740e;">" "</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>call-interactively 'compile<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-check</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Run `</span><span style="color: #8f3f71;">beancount-check-program</span><span style="color: #79740e;">'."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>compilation-read-command nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beancount--run beancount-check-program
                    <span style="color: #d65d0e;">(</span>file-relative-name buffer-file-name<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-query-program</span> <span style="color: #79740e;">"bean-query"</span>
  <span style="color: #79740e;">"Program to run to run just the parser and validator on an</span>
<span style="color: #79740e;">  input file."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-query</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Run bean-query."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">Don't let-bind compilation-read-command this time, since the default</span>
  <span style="color: #a89984;">;; </span><span style="color: #a89984;">command is incomplete.</span>
  <span style="color: #b16286;">(</span>beancount--run beancount-query-program
                  <span style="color: #8ec07c;">(</span>file-relative-name buffer-file-name<span style="color: #8ec07c;">)</span> t<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-doctor-program</span> <span style="color: #79740e;">"bean-doctor"</span>
  <span style="color: #79740e;">"Program to run the doctor commands."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-context</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Get the \"context\" from `</span><span style="color: #8f3f71;">beancount-doctor-program</span><span style="color: #79740e;">'."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>compilation-read-command nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beancount--run beancount-doctor-program <span style="color: #79740e;">"context"</span>
                    <span style="color: #d65d0e;">(</span>file-relative-name buffer-file-name<span style="color: #d65d0e;">)</span>
                    <span style="color: #d65d0e;">(</span>number-to-string <span style="color: #458588;">(</span>line-number-at-pos<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">There is no length limit for links but it seems reasonable to</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">limit the search for the link to the 128 characters before and</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">after the point. This number is chosen arbitrarily.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--bounds-of-account-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span>thing-at-point-looking-at beancount-account-regexp 128<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>cons <span style="color: #d65d0e;">(</span>match-beginning 0<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 0<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span>put 'beancount-account 'bounds-of-thing-at-point #'beancount--bounds-of-account-at-point<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--bounds-of-link-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span>thing-at-point-looking-at <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"\\^["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #d65d0e;">)</span> 128<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>cons <span style="color: #d65d0e;">(</span>match-beginning 0<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 0<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span>put 'beancount-link 'bounds-of-thing-at-point #'beancount--bounds-of-link-at-point<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--bounds-of-tag-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span>thing-at-point-looking-at <span style="color: #d65d0e;">(</span>concat <span style="color: #79740e;">"\\#["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #d65d0e;">)</span> 128<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>cons <span style="color: #d65d0e;">(</span>match-beginning 0<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>match-end 0<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span>put 'beancount-tag 'bounds-of-thing-at-point #'beancount--bounds-of-tag-at-point<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-linked--get-target-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Get link, tag or line at point, or nil."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>lnarg <span style="color: #458588;">(</span><span style="color: #9d0006;">if</span> mark-active
                   <span style="color: #b16286;">(</span>format <span style="color: #79740e;">"%d:%d"</span>
                           <span style="color: #8ec07c;">(</span>line-number-at-pos <span style="color: #d65d0e;">(</span>region-beginning<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
                           <span style="color: #8ec07c;">(</span>line-number-at-pos <span style="color: #d65d0e;">(</span>region-end<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                 <span style="color: #b16286;">(</span>format <span style="color: #79740e;">"%d"</span> <span style="color: #8ec07c;">(</span>line-number-at-pos<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>link-word <span style="color: #b16286;">(</span>thing-at-point 'beancount-link<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>link <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> link-word <span style="color: #d65d0e;">(</span>string-match <span style="color: #79740e;">"\\^"</span> link-word<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> link-word<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>tag-word <span style="color: #b16286;">(</span>thing-at-point 'beancount-tag<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>tag <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> tag-word <span style="color: #d65d0e;">(</span>string-match <span style="color: #79740e;">"\\#"</span> tag-word<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> tag-word<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> link tag lnarg<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-linked</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Get the \"linked\" info from `</span><span style="color: #8f3f71;">beancount-doctor-program</span><span style="color: #79740e;">', either linked or tags</span>
<span style="color: #79740e;">transactions at point."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>compilation-read-command nil<span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>target <span style="color: #458588;">(</span>beancount-linked--get-target-at-point<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beancount--run beancount-doctor-program <span style="color: #79740e;">"linked"</span>
                    buffer-file-name
                    target<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">Note: Eventually we'd like to be able to honor some metadata in the file that</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">would point to the top-level filename.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-command-on-region</span> <span style="color: #b16286;">(</span>rmin rmax command<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Run a command with a region as the final arguments."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> <span style="color: #8ec07c;">(</span>use-region-p<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>compilation-read-command nil<span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>args <span style="color: #b16286;">(</span>append command
                         <span style="color: #8ec07c;">(</span>list buffer-file-name
                               <span style="color: #d65d0e;">(</span>format <span style="color: #79740e;">"%d:%d"</span>
                                       <span style="color: #458588;">(</span>line-number-at-pos rmin<span style="color: #458588;">)</span>
                                       <span style="color: #458588;">(</span>line-number-at-pos
                                        <span style="color: #458588;">(</span><span style="color: #9d0006;">if</span> <span style="color: #b16286;">(</span>= 0 <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">save-excursion</span> <span style="color: #d65d0e;">(</span>goto-char rmax<span style="color: #d65d0e;">)</span> <span style="color: #d65d0e;">(</span>current-column<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
                                            <span style="color: #b16286;">(</span>1- rmax<span style="color: #b16286;">)</span> rmax<span style="color: #458588;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
                               <span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span>apply #'beancount--run args<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-region-default</span> <span style="color: #b16286;">(</span>rmin rmax<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"r"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-command-on-region rmin rmax <span style="color: #8ec07c;">(</span>list beancount-doctor-program <span style="color: #79740e;">"region"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-region-value</span> <span style="color: #b16286;">(</span>rmin rmax<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"r"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-command-on-region rmin rmax <span style="color: #8ec07c;">(</span>list beancount-doctor-program <span style="color: #79740e;">"region"</span> <span style="color: #79740e;">"--conversion=value"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-region-cost</span> <span style="color: #b16286;">(</span>rmin rmax<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"r"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-command-on-region rmin rmax <span style="color: #8ec07c;">(</span>list beancount-doctor-program <span style="color: #79740e;">"region"</span> <span style="color: #79740e;">"--conversion=cost"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-price-program</span> <span style="color: #79740e;">"bean-price"</span>
  <span style="color: #79740e;">"Program to run the price fetching commands."</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-insert-prices</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Run bean-price on the current file and insert the output inline."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>call-process beancount-price-program nil t nil
                <span style="color: #8ec07c;">(</span>file-relative-name buffer-file-name<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Transaction highlight.</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-highlight-overlay</span> <span style="color: #b16286;">(</span>list<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span>make-variable-buffer-local 'beancount-highlight-overlay<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-highlight-overlay-make</span> <span style="color: #b16286;">()</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>overlay <span style="color: #458588;">(</span>make-overlay 1 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>overlay-put overlay 'face 'beancount-highlight<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>overlay-put overlay 'priority '<span style="color: #d65d0e;">(</span>nil . 99<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    overlay<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-highlight-transaction-at-point</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Move the highlight overlay to the current transaction."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> beancount-highlight-transaction-at-point
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">unless</span> beancount-highlight-overlay
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">setq</span> beancount-highlight-overlay <span style="color: #458588;">(</span>beancount-highlight-overlay-make<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">let*</span> <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>bounds <span style="color: #b16286;">(</span>beancount-find-transaction-extents <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>begin <span style="color: #b16286;">(</span>car bounds<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span>end <span style="color: #b16286;">(</span>cadr bounds<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
      <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> <span style="color: #458588;">(</span>&gt; <span style="color: #b16286;">(</span>- end begin<span style="color: #b16286;">)</span> 0<span style="color: #458588;">)</span>
          <span style="color: #458588;">(</span>move-overlay beancount-highlight-overlay begin end<span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span>move-overlay beancount-highlight-overlay 1 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Outline minor mode support.</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-outline-cycle</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Implement visibility cycling a la `</span><span style="color: #8f3f71;">org-mode</span><span style="color: #79740e;">'.</span>

<span style="color: #79740e;">The behavior of this command is determined by the first matching</span>
<span style="color: #79740e;">condition among the following:</span>

<span style="color: #79740e;"> 1. When point is at the beginning of the buffer, or when called</span>
<span style="color: #79740e;">    with a `\\[</span><span style="color: #8f3f71;">universal-argumen</span><span style="color: #79740e;">t]' universal argument, rotate the entire buffer</span>
<span style="color: #79740e;">    through 3 states:</span>

<span style="color: #79740e;">   - OVERVIEW: Show only top-level headlines.</span>
<span style="color: #79740e;">   - CONTENTS: Show all headlines of all levels, but no body text.</span>
<span style="color: #79740e;">   - SHOW ALL: Show everything.</span>

<span style="color: #79740e;"> 2. When point is at the beginning of a headline, rotate the</span>
<span style="color: #79740e;">    subtree starting at this line through 3 different states:</span>

<span style="color: #79740e;">   - FOLDED:   Only the main headline is shown.</span>
<span style="color: #79740e;">   - CHILDREN: The main headline and its direct children are shown.</span>
<span style="color: #79740e;">               From this state, you can move to one of the children</span>
<span style="color: #79740e;">               and zoom in further.</span>

<span style="color: #79740e;">   - SUBTREE:  Show the entire subtree, including body text."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> deactivate-mark t<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">cond</span>
   <span style="color: #a89984;">;; </span><span style="color: #a89984;">Beginning of buffer or called with C-u: Global cycling</span>
   <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> <span style="color: #458588;">(</span>equal arg '<span style="color: #b16286;">(</span>4<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
        <span style="color: #458588;">(</span><span style="color: #9d0006;">and</span> <span style="color: #b16286;">(</span>bobp<span style="color: #b16286;">)</span>
             <span style="color: #a89984;">;; </span><span style="color: #a89984;">org-mode style behaviour - only cycle if not on a heading</span>
             <span style="color: #b16286;">(</span>not <span style="color: #8ec07c;">(</span>outline-on-heading-p<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
    <span style="color: #d65d0e;">(</span>beancount-cycle-buffer<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>

   <span style="color: #a89984;">;; </span><span style="color: #a89984;">At a heading: rotate between three different views</span>
   <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span><span style="color: #9d0006;">save-excursion</span> <span style="color: #458588;">(</span>beginning-of-line 1<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>looking-at outline-regexp<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
    <span style="color: #d65d0e;">(</span>outline-back-to-heading<span style="color: #d65d0e;">)</span>
    <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">let</span> <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>goal-column 0<span style="color: #b16286;">)</span> eoh eol eos<span style="color: #458588;">)</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">First, some boundaries</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">save-excursion</span>
        <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span> <span style="color: #8ec07c;">(</span>beancount-next-line<span style="color: #8ec07c;">)</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> eol <span style="color: #d65d0e;">(</span>point<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
        <span style="color: #b16286;">(</span>outline-end-of-heading<span style="color: #b16286;">)</span>              <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> eoh <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
        <span style="color: #b16286;">(</span>outline-end-of-subtree<span style="color: #b16286;">)</span>              <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> eos <span style="color: #8ec07c;">(</span>point<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Find out what to do next and set `</span><span style="color: #8f3f71;">this-command</span><span style="color: #a89984;">'</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">cond</span>
       <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>= eos eoh<span style="color: #8ec07c;">)</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">Nothing is hidden behind this heading</span>
        <span style="color: #8ec07c;">(</span>beancount-message <span style="color: #79740e;">"EMPTY ENTRY"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
       <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>&gt;= eol eos<span style="color: #8ec07c;">)</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">Entire subtree is hidden in one line: open it</span>
        <span style="color: #8ec07c;">(</span>outline-show-entry<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span>outline-show-children<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span>beancount-message <span style="color: #79740e;">"CHILDREN"</span><span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span>
         this-command 'beancount-cycle-children<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
       <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>eq last-command 'beancount-cycle-children<span style="color: #8ec07c;">)</span>
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">We just showed the children, now show everything.</span>
        <span style="color: #8ec07c;">(</span>outline-show-subtree<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span>beancount-message <span style="color: #79740e;">"SUBTREE"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
       <span style="color: #b16286;">(</span>t
        <span style="color: #a89984;">;; </span><span style="color: #a89984;">Default action: hide the subtree.</span>
        <span style="color: #8ec07c;">(</span>outline-hide-subtree<span style="color: #8ec07c;">)</span>
        <span style="color: #8ec07c;">(</span>beancount-message <span style="color: #79740e;">"FOLDED"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-current-buffer-visibility-state</span> nil
  <span style="color: #79740e;">"Current visibility state of buffer."</span><span style="color: #458588;">)</span>
<span style="color: #458588;">(</span>make-variable-buffer-local 'beancount-current-buffer-visibility-state<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount-current-buffer-visibility-state</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-cycle-buffer</span> <span style="color: #b16286;">(</span><span style="color: #8f3f71;">&amp;optional</span> arg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Rotate the visibility state of the buffer through 3 states:</span>
<span style="color: #79740e;">  - OVERVIEW: Show only top-level headlines.</span>
<span style="color: #79740e;">  - CONTENTS: Show all headlines of all levels, but no body text.</span>
<span style="color: #79740e;">  - SHOW ALL: Show everything.</span>

<span style="color: #79740e;">With a numeric prefix ARG, show all headlines up to that level."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span> <span style="color: #79740e;">"P"</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">save-excursion</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cond</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>integerp arg<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>outline-show-all<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>outline-hide-sublevels arg<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>eq last-command 'beancount-cycle-overview<span style="color: #458588;">)</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">We just created the overview - now do table of contents</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">This can be slow in very large buffers, so indicate action</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Visit all headings and show their offspring</span>
      <span style="color: #458588;">(</span>goto-char <span style="color: #b16286;">(</span>point-max<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">while</span> <span style="color: #b16286;">(</span>not <span style="color: #8ec07c;">(</span>bobp<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
        <span style="color: #b16286;">(</span><span style="color: #9d0006;">condition-case</span> nil
            <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">progn</span>
              <span style="color: #d65d0e;">(</span>outline-previous-visible-heading 1<span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span>outline-show-branches<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
          <span style="color: #8ec07c;">(</span><span style="color: #9d0006; font-weight: bold;">error</span> <span style="color: #d65d0e;">(</span>goto-char <span style="color: #458588;">(</span>point-min<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>beancount-message <span style="color: #79740e;">"CONTENTS"</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> this-command 'beancount-cycle-toc
            beancount-current-buffer-visibility-state 'contents<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>eq last-command 'beancount-cycle-toc<span style="color: #458588;">)</span>
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">We just showed the table of contents - now show everything</span>
      <span style="color: #458588;">(</span>outline-show-all<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>beancount-message <span style="color: #79740e;">"SHOW ALL"</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> this-command 'beancount-cycle-showall
            beancount-current-buffer-visibility-state 'all<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     <span style="color: #d65d0e;">(</span>t
      <span style="color: #a89984;">;; </span><span style="color: #a89984;">Default action: go to overview</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">let</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>toplevel
             <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">cond</span>
              <span style="color: #458588;">(</span>current-prefix-arg
               <span style="color: #458588;">(</span>prefix-numeric-value current-prefix-arg<span style="color: #458588;">)</span><span style="color: #458588;">)</span>
              <span style="color: #458588;">(</span><span style="color: #458588;">(</span><span style="color: #9d0006;">save-excursion</span>
                 <span style="color: #b16286;">(</span>beginning-of-line<span style="color: #b16286;">)</span>
                 <span style="color: #b16286;">(</span>looking-at outline-regexp<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
               <span style="color: #458588;">(</span>max 1 <span style="color: #b16286;">(</span>funcall outline-level<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #458588;">)</span>
              <span style="color: #458588;">(</span>t 1<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
        <span style="color: #b16286;">(</span>outline-hide-sublevels toplevel<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span>beancount-message <span style="color: #79740e;">"OVERVIEW"</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> this-command 'beancount-cycle-overview
            beancount-current-buffer-visibility-state 'overview<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-message</span> <span style="color: #b16286;">(</span>msg<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Display MSG, but avoid logging it in the *Messages* buffer."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>message-log-max nil<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>message msg<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-next-line</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Forward line, but mover over invisible line ends.</span>
<span style="color: #79740e;">Essentially a much simplified version of `</span><span style="color: #8f3f71;">next-line</span><span style="color: #79740e;">'."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beginning-of-line 2<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">while</span> <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">and</span> <span style="color: #d65d0e;">(</span>not <span style="color: #458588;">(</span>eobp<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
              <span style="color: #d65d0e;">(</span>get-char-property <span style="color: #458588;">(</span>1- <span style="color: #b16286;">(</span>point<span style="color: #b16286;">)</span><span style="color: #458588;">)</span> 'invisible<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>beginning-of-line 2<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>


<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Fava</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defvar</span> <span style="color: #076678;">beancount--fava-process</span> nil<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-fava</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Start (and open) or stop the fava server."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">interactive</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when</span> beancount--fava-process
    <span style="color: #8ec07c;">(</span>delete-process beancount--fava-process<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> beancount--fava-process nil<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>message <span style="color: #79740e;">"Fava process killed"</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">setq</span> beancount--fava-process
        <span style="color: #8ec07c;">(</span>start-process <span style="color: #79740e;">"fava"</span> <span style="color: #d65d0e;">(</span>get-buffer-create <span style="color: #79740e;">"*fava*"</span><span style="color: #d65d0e;">)</span> <span style="color: #79740e;">"fava"</span>
                       <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">if</span> <span style="color: #458588;">(</span>eq 'beancount-mode major-mode<span style="color: #458588;">)</span> <span style="color: #458588;">(</span>buffer-file-name<span style="color: #458588;">)</span>
                         <span style="color: #458588;">(</span>read-file-name <span style="color: #79740e;">"File to load: "</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>set-process-filter beancount--fava-process #'beancount--fava-filter<span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>message <span style="color: #79740e;">"Fava process started"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount--fava-filter</span> <span style="color: #b16286;">(</span>_process output<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Open fava url as soon as the address is announced."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">with-current-buffer</span> <span style="color: #79740e;">"*fava*"</span> <span style="color: #8ec07c;">(</span>insert output<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">if-let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>url <span style="color: #458588;">(</span>string-match <span style="color: #79740e;">"Starting Fava on </span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">(</span><span style="color: #79740e;">http://.+:[0-9]+</span><span style="color: #79740e; font-weight: bold;">\\</span><span style="color: #79740e; font-weight: bold;">)</span><span style="color: #79740e;">\n"</span> output<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
      <span style="color: #8ec07c;">(</span>browse-url <span style="color: #d65d0e;">(</span>match-string 1 output<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;;; </span><span style="color: #a89984;">Xref backend</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-xref-backend</span> <span style="color: #b16286;">()</span>
  <span style="color: #79740e;">"Beancount Xref backend."</span>
  'beancount<span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">cl-defmethod</span> <span style="color: #b57614;">xref-backend-definitions</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>_ <span style="color: #d65d0e;">(</span>eql beancount<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> identifier<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Find definitions of IDENTIFIER."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>buf <span style="color: #458588;">(</span>current-buffer<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        re mgroup<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cond</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">tag</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>string-prefix-p <span style="color: #79740e;">"#"</span> identifier<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> re <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"#["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> mgroup 0<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">link</span>
     <span style="color: #d65d0e;">(</span><span style="color: #458588;">(</span>string-prefix-p <span style="color: #79740e;">"^"</span> identifier<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> re <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"\\^["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> mgroup 0<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     <span style="color: #a89984;">;; </span><span style="color: #a89984;">account</span>
     <span style="color: #d65d0e;">(</span>t
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> re beancount-open-directive-regexp<span style="color: #458588;">)</span>
      <span style="color: #458588;">(</span><span style="color: #9d0006;">setq</span> mgroup 3<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cl-loop</span>
       for <span style="color: #d65d0e;">(</span>def-id . def-pos<span style="color: #d65d0e;">)</span> in
       <span style="color: #d65d0e;">(</span>beancount-collect-pos-alist re mgroup<span style="color: #d65d0e;">)</span>
       if <span style="color: #d65d0e;">(</span>equal def-id identifier<span style="color: #d65d0e;">)</span>
       collect
       <span style="color: #d65d0e;">(</span>xref-make def-id <span style="color: #458588;">(</span>xref-make-buffer-location buf def-pos<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">cl-defmethod</span> <span style="color: #b57614;">xref-backend-references</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>_ <span style="color: #d65d0e;">(</span>eql beancount<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> identifier<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Find references of IDENTIFIER."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>fname <span style="color: #458588;">(</span>buffer-file-name<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        re<span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">setq</span> re
          <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">cond</span>
           <span style="color: #a89984;">;; </span><span style="color: #a89984;">tag</span>
           <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>string-prefix-p <span style="color: #79740e;">"#"</span> identifier<span style="color: #b16286;">)</span>
            <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"#["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #a89984;">;; </span><span style="color: #a89984;">link</span>
           <span style="color: #458588;">(</span><span style="color: #b16286;">(</span>string-prefix-p <span style="color: #79740e;">"^"</span> identifier<span style="color: #b16286;">)</span>
            <span style="color: #b16286;">(</span>concat <span style="color: #79740e;">"\\^["</span> beancount-tag-chars <span style="color: #79740e;">"]+"</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>
           <span style="color: #a89984;">;; </span><span style="color: #a89984;">account</span>
           <span style="color: #458588;">(</span>t beancount-account-regexp<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cl-loop</span>
     for <span style="color: #d65d0e;">(</span>ref-id . ref-pos<span style="color: #d65d0e;">)</span> in
     <span style="color: #d65d0e;">(</span>beancount-collect-pos-alist re 0<span style="color: #d65d0e;">)</span>
     if <span style="color: #d65d0e;">(</span>equal ref-id identifier<span style="color: #d65d0e;">)</span>
     collect
     <span style="color: #d65d0e;">(</span>xref-make ref-id
                <span style="color: #458588;">(</span>xref-make-file-location
                 fname <span style="color: #b16286;">(</span>line-number-at-pos ref-pos<span style="color: #b16286;">)</span> 0<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #a89984;">;; </span><span style="color: #a89984;">NOTE: This is a backport from Emacs 27 and newer versions. Can be</span>
<span style="color: #a89984;">;; </span><span style="color: #a89984;">removed once beancount-mode no longer supports Emacs 26.</span>
<span style="color: #458588;">(</span><span style="color: #9d0006;">defun</span> <span style="color: #b57614;">beancount-xref-apropos-regexp</span> <span style="color: #b16286;">(</span>pattern<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Return an Emacs regexp from PATTERN similar to `</span><span style="color: #8f3f71;">apropos</span><span style="color: #79740e;">'."</span>
  <span style="color: #b16286;">(</span>apropos-parse-pattern
   <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">if</span> <span style="color: #d65d0e;">(</span>string-equal <span style="color: #458588;">(</span>regexp-quote pattern<span style="color: #458588;">)</span> pattern<span style="color: #d65d0e;">)</span>
       <span style="color: #a89984;">;; </span><span style="color: #a89984;">Split into words</span>
       <span style="color: #d65d0e;">(</span><span style="color: #9d0006;">or</span> <span style="color: #458588;">(</span>split-string pattern <span style="color: #79740e;">"[ \t]+"</span> t<span style="color: #458588;">)</span>
           <span style="color: #458588;">(</span><span style="color: #9d0006; font-weight: bold;">user-error</span> <span style="color: #79740e;">"No word list given"</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
     pattern<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">cl-defmethod</span> <span style="color: #b57614;">xref-backend-apropos</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>_ <span style="color: #d65d0e;">(</span>eql beancount<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span> pattern<span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Find all symbols that match PATTERN string."</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>pattern-re <span style="color: #458588;">(</span>beancount-xref-apropos-regexp pattern<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span>
        <span style="color: #d65d0e;">(</span>fname <span style="color: #458588;">(</span>buffer-file-name<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span><span style="color: #9d0006;">cl-loop</span>
     for <span style="color: #d65d0e;">(</span>ref-id . ref-pos<span style="color: #d65d0e;">)</span> in
     <span style="color: #d65d0e;">(</span>beancount-collect-pos-alist beancount-xref-symbol-regexp 0<span style="color: #d65d0e;">)</span>
     if <span style="color: #d65d0e;">(</span>string-match-p pattern-re ref-id<span style="color: #d65d0e;">)</span>
     collect
     <span style="color: #d65d0e;">(</span>xref-make ref-id
                <span style="color: #458588;">(</span>xref-make-file-location
                 fname <span style="color: #b16286;">(</span>line-number-at-pos ref-pos<span style="color: #b16286;">)</span> 0<span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">cl-defmethod</span> <span style="color: #b57614;">xref-backend-identifier-completion-table</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>_ <span style="color: #d65d0e;">(</span>eql beancount<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #b16286;">(</span>beancount-collect-unique beancount-xref-symbol-regexp 0<span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">cl-defmethod</span> <span style="color: #b57614;">xref-backend-identifier-at-point</span> <span style="color: #b16286;">(</span><span style="color: #8ec07c;">(</span>_ <span style="color: #d65d0e;">(</span>eql beancount<span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>
  <span style="color: #79740e;">"Extract a symbol at point, check if it is an account, return it"</span>
  <span style="color: #b16286;">(</span><span style="color: #9d0006;">when-let</span> <span style="color: #8ec07c;">(</span><span style="color: #d65d0e;">(</span>thing <span style="color: #458588;">(</span><span style="color: #9d0006;">or</span> <span style="color: #b16286;">(</span>thing-at-point 'beancount-account<span style="color: #b16286;">)</span>
                        <span style="color: #b16286;">(</span>thing-at-point 'beancount-link<span style="color: #b16286;">)</span>
                        <span style="color: #b16286;">(</span>thing-at-point 'beancount-tag<span style="color: #b16286;">)</span><span style="color: #458588;">)</span><span style="color: #d65d0e;">)</span><span style="color: #8ec07c;">)</span>
    <span style="color: #8ec07c;">(</span>substring-no-properties thing<span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span><span style="color: #458588;">)</span>

<span style="color: #458588;">(</span><span style="color: #9d0006;">provide</span> '<span style="color: #8f3f71;">beancount</span><span style="color: #458588;">)</span>
<span style="color: #a89984;">;;; </span><span style="color: #a89984;">beancount.el ends here</span>

</pre>
</div>
</div>
<div id="postamble" class="status">
<p>▲ 编辑于 <span class="timestamp-wrapper"><span class="timestamp">[2025-01-16 周四 00:08]</span></span>　|　© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.7.19) on <span class="timestamp-wrapper"><span class="timestamp">[2025-01-16 周四 00:08]</span></span>　|　<a href="https://tomoemami.github.io/rss.xml">RSS</a></p>
</div>
</body>
</html>
