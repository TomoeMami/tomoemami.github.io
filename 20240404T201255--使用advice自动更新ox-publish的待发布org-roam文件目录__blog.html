<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-01-20 周二 11:32 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用advice自动更新ox-publish的待发布org-roam文件目录</title>
<meta name="generator" content="Org Mode" />
<link rel='stylesheet' type='text/css' href='/org.css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="preamble" class="status">
<p>▼ 本文更新于 <span class="timestamp-wrapper"><span class="timestamp">[2026-01-20 周二 11:32]</span></span></p>
</div>
<div id="content" class="content">
<header>
<h1 class="title">使用advice自动更新ox-publish的待发布org-roam文件目录</h1>
</header><p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2024-04-04T20:12:00">[2024-04-04 周四 20:12]</time></span><br>
</p>

<p>
最近在研究用Emacs写博客。由于并不在意博客样式，因此选择用ox-publish直接将指定的org-roam文件导出为html再上传GitHub通过GitHub Pages托管。<br>
</p>

<p>
参考文献：<br>
<a href="https://zhuanlan.zhihu.com/p/634873048">Emacs: 使用 org publish 生成个人博客</a><br>
<a href="https://zhuanlan.zhihu.com/p/601052964">26.ox-html 浅析与 ox-publish 使用介绍</a><br>
</p>

<p>
由于org-roam的所有文件均在一个文件夹内，又不需要将所有的文件作为博客内容发表，因此接下来会利用org-roam的功能，动态发布打上了 <code>blog</code> 标签的文件。<br>
</p>
<div id="outline-container-org3b12432" class="outline-2">
<h2 id="org3b12432"><span class="section-number-2">1.</span> 获取带blog标签的文件</h2>
<div class="outline-text-2" id="text-1">
<p>
参考<a href="https://d12frosted.io/posts/2021-01-16-task-management-with-roam-vol5.html">Vulpea的org-roam动态agenda</a>文件，创建函数如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">defun</span> <span style="color: #5a7400;">my/ox-files</span> <span style="color: #a26310;">()</span>
  <span style="color: #b05350;">"Return a list of note files containing '</span><span style="color: #3f60af;">blog</span><span style="color: #b05350;">' tag."</span> <span style="color: #7f6f1a;">;</span><span style="color: #7f6f1a;">
</span>  <span style="color: #a26310;">(</span>seq-uniq
   <span style="color: #5a7400;">(</span>seq-map
    #'car
    <span style="color: #c02945;">(</span>org-roam-db-query
     <span style="color: #4060a0;">[</span><span style="color: #946830;">:select</span> <span style="color: #aa3e74;">[</span>nodes:file<span style="color: #aa3e74;">]</span>
              <span style="color: #946830;">:from</span> tags
              <span style="color: #946830;">:left-join</span> nodes
              <span style="color: #946830;">:on</span> <span style="color: #aa3e74;">(</span>= tags:node-id nodes:id<span style="color: #aa3e74;">)</span>
              <span style="color: #946830;">:where</span> <span style="color: #aa3e74;">(</span>like tag <span style="color: #008250;">(</span><span style="color: #a26310;">quote</span> <span style="color: #c74400;">"%\"blog\"%"</span><span style="color: #008250;">)</span><span style="color: #aa3e74;">)</span><span style="color: #4060a0;">]</span><span style="color: #c02945;">)</span><span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>
</code></pre>
</div>

<p>
上述函数可以返回org-roam-db中标有 <code>blog</code> 的文件路径列表。<br>
</p>
</div>
</div>
<div id="outline-container-org2228eca" class="outline-2">
<h2 id="org2228eca"><span class="section-number-2">2.</span> 配置ox-publish</h2>
<div class="outline-text-2" id="text-2">
<p>
根据参考文献，需要指定 <code>org-publish-project-alist</code> 如下：<br>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">setq</span> org-publish-project-alist
        `<span style="color: #a26310;">(</span><span style="color: #5a7400;">(</span><span style="color: #c74400;">"posts"</span>
           <span style="color: #946830;">:base-directory</span> ,website-directory
           <span style="color: #946830;">:base-extension</span> <span style="color: #c74400;">"org"</span>
           <span style="color: #946830;">:publishing-directory</span> ,my/publish-directory
           <span style="color: #946830;">:publishing-function</span> org-html-publish-to-html
           <span style="color: #946830;">:with-author</span> t
           <span style="color: #946830;">:auto-sitemap</span> t
           <span style="color: #946830;">:recursive</span> nil
           <span style="color: #946830;">:exclude</span> <span style="color: #c74400;">".*"</span>
           <span style="color: #946830;">:include</span> ,<span style="color: #c02945;">(</span>my/ox-files<span style="color: #c02945;">)</span>
           <span style="color: #946830;">:html-link-home</span> <span style="color: #c74400;">"index.html"</span>
           <span style="color: #946830;">:sitemap-filename</span> <span style="color: #c74400;">"index.org"</span>
           <span style="color: #946830;">:sitemap-title</span> <span style="color: #c74400;">"&#30446;&#24405;"</span>
           <span style="color: #946830;">:sitemap-sort-files</span> anti-chronologically
           <span style="color: #946830;">:html-head:css</span> <span style="color: #c74400;">"&lt;link rel='</span><span style="color: #3f60af;">stylesheet</span><span style="color: #c74400;">' type='</span><span style="color: #3f60af;">text/css</span><span style="color: #c74400;">' href='</span><span style="color: #3f60af;">/org.css</span><span style="color: #c74400;">'/&gt;"</span><span style="color: #5a7400;">)</span>
          <span style="color: #5a7400;">(</span><span style="color: #c74400;">"personal-website"</span> <span style="color: #946830;">:components</span> <span style="color: #c02945;">(</span><span style="color: #c74400;">"posts"</span><span style="color: #c02945;">)</span><span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>
</code></pre>
</div>

<p>
上图代码通过 <code>:exclude ".*"</code> 排除所有文件，然后通过 <code>:include ,(my/ox-files)</code> 将带有 <code>blog</code> 标签的org-roam文件路径纳入 <code>ox-publish</code> 的处理范畴中<br>
</p>
</div>
</div>
<div id="outline-container-org2a5ad74" class="outline-2">
<h2 id="org2a5ad74"><span class="section-number-2">3.</span> 动态更新待发布文件列表</h2>
<div class="outline-text-2" id="text-3">
<p>
由于上述 <code>org-publish-project-alist</code> 仅会执行单次，因此需要通过 <code>advice-add</code> 的方式让其在每次发布时均执行一次，达成动态更新的效果。<br>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">defun</span> <span style="color: #5a7400;">my/org-project-update</span> <span style="color: #a26310;">(</span><span style="color: #008250;">&amp;optional</span> ARG PRED<span style="color: #a26310;">)</span> <span style="color: #7f6f1a;">;;</span><span style="color: #7f6f1a;">&#20351;&#29992;before&#20250;&#25509;&#25910;&#21040;&#21407;&#20989;&#25968;&#21442;&#25968;&#65292;&#22240;&#27492;&#38656;&#35201;&#28155;&#21152;optional
</span>  <span style="color: #a26310;">(</span><span style="color: #a26310;">setq</span> org-publish-project-alist
        `<span style="color: #5a7400;">(</span><span style="color: #c02945;">(</span><span style="color: #c74400;">"posts"</span>
           <span style="color: #946830;">:base-directory</span> ,website-directory
           <span style="color: #946830;">:base-extension</span> <span style="color: #c74400;">"org"</span>
           <span style="color: #946830;">:publishing-directory</span> ,my/publish-directory
           <span style="color: #946830;">:publishing-function</span> org-html-publish-to-html
           <span style="color: #946830;">:with-author</span> t
           <span style="color: #946830;">:auto-sitemap</span> t
           <span style="color: #946830;">:recursive</span> nil
           <span style="color: #946830;">:exclude</span> <span style="color: #c74400;">".*"</span>
           <span style="color: #946830;">:include</span> ,<span style="color: #4060a0;">(</span>my/ox-files<span style="color: #4060a0;">)</span>
           <span style="color: #946830;">:html-link-home</span> <span style="color: #c74400;">"index.html"</span>
           <span style="color: #946830;">:sitemap-filename</span> <span style="color: #c74400;">"index.org"</span>
           <span style="color: #946830;">:sitemap-title</span> <span style="color: #c74400;">"&#30446;&#24405;"</span>
           <span style="color: #946830;">:sitemap-sort-files</span> anti-chronologically
           <span style="color: #946830;">:html-head:css</span> <span style="color: #c74400;">"&lt;link rel='</span><span style="color: #3f60af;">stylesheet</span><span style="color: #c74400;">' type='</span><span style="color: #3f60af;">text/css</span><span style="color: #c74400;">' href='</span><span style="color: #3f60af;">/org.css</span><span style="color: #c74400;">'/&gt;"</span><span style="color: #c02945;">)</span>
          <span style="color: #c02945;">(</span><span style="color: #c74400;">"personal-website"</span> <span style="color: #946830;">:components</span> <span style="color: #4060a0;">(</span><span style="color: #c74400;">"posts"</span><span style="color: #4060a0;">)</span><span style="color: #c02945;">)</span><span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>
<span style="color: #ba5205;">(</span>advice-add 'org-export-dispatch <span style="color: #946830;">:before</span> 'my/org-project-update<span style="color: #ba5205;">)</span>
</code></pre>
</div>

<p>
这样，每次 <code>org-export-dispatch</code> 函数（按键为 <code>C-c C-e</code> ）运行前，均会更新待发布文件路径。<br>
</p>
</div>
</div>
<div id="outline-container-org2bd897e" class="outline-2">
<h2 id="org2bd897e"><span class="section-number-2">4.</span> 为每个html文件插入CSS</h2>
<div class="outline-text-2" id="text-4">
<p>
利用 <code>org-export</code> 的hook自动设置，读取 <code>~/.emacs.d/org.css</code> 文件内容并插入发布的html文件中<br>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">defun</span> <span style="color: #5a7400;">my/org-inline-css-hook</span> <span style="color: #a26310;">(</span>exporter<span style="color: #a26310;">)</span>
  <span style="color: #b05350;">"Insert custom inline css"</span>
  <span style="color: #a26310;">(</span><span style="color: #a26310;">when</span> <span style="color: #5a7400;">(</span>eq exporter 'html<span style="color: #5a7400;">)</span>
    <span style="color: #5a7400;">(</span><span style="color: #a26310;">setq</span> org-html-head-include-default-style nil<span style="color: #5a7400;">)</span>
    <span style="color: #5a7400;">(</span><span style="color: #a26310;">setq</span> org-html-head <span style="color: #c02945;">(</span>concat <span style="color: #c74400;">"&lt;style type=\"text/css\"&gt;\n &lt;!--/*--&gt;&lt;![CDATA[/*&gt;&lt;!--*/\n"</span> <span style="color: #4060a0;">(</span><span style="color: #a26310;">with-temp-buffer</span> <span style="color: #aa3e74;">(</span>insert-file-contents <span style="color: #c74400;">"~/.emacs.d/org.css"</span><span style="color: #aa3e74;">)</span> <span style="color: #aa3e74;">(</span>buffer-string<span style="color: #aa3e74;">)</span><span style="color: #4060a0;">)</span> <span style="color: #c74400;">"/*] ]&gt;*/--&gt;\n &lt;/style&gt;\n"</span><span style="color: #c02945;">)</span><span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>

<span style="color: #ba5205;">(</span>add-hook 'org-export-before-processing-hook 'my/org-inline-css-hook<span style="color: #ba5205;">)</span>
</code></pre>
</div>


<p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2026-01-05T17:11:00">[2026-01-05 周一 17:11]</time></span> ：现在改为引用独立的 =org.css=，缩减HTML文件大小。<br>
</p>

<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">defun</span> <span style="color: #5a7400;">my/org-inline-css-hook</span> <span style="color: #a26310;">(</span>exporter<span style="color: #a26310;">)</span>
  <span style="color: #b05350;">"&#22312;&#23548;&#20986;&#30340;'</span><span style="color: #3f60af;">html</span><span style="color: #b05350;">'&#25991;&#20214;&#39318;&#39029;&#25554;&#20837;&#33258;&#23450;&#20041;&#30340;CSS&#25991;&#20214;"</span>
  <span style="color: #a26310;">(</span><span style="color: #a26310;">when</span> <span style="color: #5a7400;">(</span>eq exporter 'html<span style="color: #5a7400;">)</span>
    <span style="color: #7f6f1a;">;; </span><span style="color: #7f6f1a;">&#21462;&#28040;&#40664;&#35748;CSS
</span>    <span style="color: #5a7400;">(</span><span style="color: #a26310;">setq</span> org-html-head-include-default-style nil<span style="color: #5a7400;">)</span>
    <span style="color: #7f6f1a;">;; </span><span style="color: #7f6f1a;">&#20851;&#38381;html validation&#38142;&#25509;
</span>    <span style="color: #5a7400;">(</span><span style="color: #a26310;">setq</span> org-html-validation-link nil<span style="color: #5a7400;">)</span>
    <span style="color: #7f6f1a;">;; </span><span style="color: #7f6f1a;">&#35774;&#32622;CSS
</span>    <span style="color: #5a7400;">(</span><span style="color: #a26310;">setq</span> org-html-head <span style="color: #c74400;">"&lt;link rel='</span><span style="color: #3f60af;">stylesheet</span><span style="color: #c74400;">' type='</span><span style="color: #3f60af;">text/css</span><span style="color: #c74400;">' href='</span><span style="color: #3f60af;">/org.css</span><span style="color: #c74400;">'/&gt;"</span><span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>

<span style="color: #ba5205;">(</span><span style="color: #a26310;">defun</span> <span style="color: #5a7400;">adv/org-publish-project-done-message</span> <span style="color: #a26310;">(</span><span style="color: #008250;">&amp;optional</span> one two three <span style="color: #a26310;">)</span>
  <span style="color: #b05350;">"&#26356;&#26032;'</span><span style="color: #3f60af;">org.css</span><span style="color: #b05350;">'"</span>
  <span style="color: #a26310;">(</span><span style="color: #a26310;">with-current-buffer</span> <span style="color: #5a7400;">(</span>find-file-noselect <span style="color: #c02945;">(</span>concat my/desktop-path <span style="color: #c74400;">"org.css"</span><span style="color: #c02945;">)</span><span style="color: #5a7400;">)</span>
    <span style="color: #5a7400;">(</span>erase-buffer<span style="color: #5a7400;">)</span>
    <span style="color: #5a7400;">(</span>insert-file-contents <span style="color: #c74400;">"~/.emacs.d/org.css"</span><span style="color: #5a7400;">)</span>
    <span style="color: #5a7400;">(</span>save-buffer<span style="color: #5a7400;">)</span><span style="color: #a26310;">)</span><span style="color: #ba5205;">)</span>

<span style="color: #ba5205;">(</span>advice-add #'org-publish-current-project <span style="color: #946830;">:after</span> #'adv/org-publish-project-done-message<span style="color: #ba5205;">)</span>
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org7d469d9" class="outline-2">
<h2 id="org7d469d9"><span class="section-number-2">5.</span> 一些其他的小设置</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org9581e39" class="outline-3">
<h3 id="org9581e39"><span class="section-number-3">5.1.</span> 导出时单换行也视为换行</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><code><span style="color: #ba5205;">(</span><span style="color: #a26310;">setq</span> org-export-preserve-breaks t<span style="color: #ba5205;">)</span>
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org3718d5f" class="outline-3">
<h3 id="org3718d5f"><span class="section-number-3">5.2.</span> <a href="20240522T214121--emacs-使用ox-rss导出rss的xml文件__blog.html">emacs-使用ox-rss导出rss的xml文件</a></h3>
</div>
<div id="outline-container-org8dbe859" class="outline-3">
<h3 id="org8dbe859"><span class="section-number-3">5.3.</span> CSS文件<a href="https://github.com/TomoeMami/tomoemami.github.io/blob/main/org.css">链接</a></h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.8-pre)　|　<a href="https://blog.prayhand13013.top/rss.xml">RSS</a>　<a href="https://blog.prayhand13013.top/20251121T151653--english-post-index__wiki.html">English-Index</a></p>
</div>
</body>
</html>
