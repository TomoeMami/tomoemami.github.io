<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-01-06 周二 17:28 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>emacs-用msys2编译windows的emacs</title>
<meta name="generator" content="Org Mode" />
<link rel='stylesheet' type='text/css' href='/org.css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="preamble" class="status">
<p>▼ 本文更新于 <span class="timestamp-wrapper"><span class="timestamp">[2026-01-06 周二 17:24]</span></span></p>
</div>
<div id="content" class="content">
<header>
<h1 class="title">emacs-用msys2编译windows的emacs</h1>
</header><p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2024-11-04T14:13:00">[2024-11-04 周一 14:13]</time></span><br>
</p>

<p>
原文: <a href="https://gist.github.com/LdBeth/d663a7d3ea27776bfe211241ad7fa5e5">https://gist.github.com/LdBeth/d663a7d3ea27776bfe211241ad7fa5e5</a><br>
</p>

<p>
作者：LdBeth<br>
</p>

<p>
原文摘录如下：<br>
</p>

<p>
This document is an up-to-date guide on compile Emacs 31 on windows<br>
with MSYS2, and make a installation with native compile that can work<br>
without MSYS2.<br>
</p>

<p>
The idea is after get a working Emacs, you may delete MSYS2<br>
environment to free some disk space, and forget about rebuilding Emacs<br>
until the next time you feel need to, without need to figure out<br>
everything again.<br>
</p>

<p>
Specially thanks to @include-yy on emacs-china.org for providing<br>
guides on UCRT64 and use GCCJIT.<br>
</p>
<div id="outline-container-orgb642979" class="outline-2">
<h2 id="orgb642979"><span class="section-number-2">1.</span> How to get MSYS2 (without installer)</h2>
<div class="outline-text-2" id="text-1">
<p>
Get from <a href="https://github.com/msys2/msys2-installer/releases/">https://github.com/msys2/msys2-installer/releases/</a><br>
</p>

<p>
You may use the 7zip SFX one.<br>
</p>
</div>
</div>
<div id="outline-container-org4d165d6" class="outline-2">
<h2 id="org4d165d6"><span class="section-number-2">2.</span> Update MSYS2 base environment</h2>
<div class="outline-text-2" id="text-2">
<p>
We are using the UCRT64.<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>sed -i <span style="color: #ca3400;">"s#https\?://mirror.msys2.org/#https://mirrors.tuna.tsinghua.edu.cn/msys2/#g"</span> /etc/pacman.d/mirrorlist*

pacman -Syu
</code></pre>
</div>

<p>
After complete, restart terminal, and run<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>pacman -Su
</code></pre>
</div>

<p>
To install the required packages for building Emacs.<br>
(Maybe other people can came up with a better list)<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>pacman -Su <span style="color: #ca3400;">\</span>
  autoconf <span style="color: #ca3400;">\</span>
  autogen <span style="color: #ca3400;">\</span>
  automake <span style="color: #ca3400;">\</span>
  automake-wrapper <span style="color: #ca3400;">\</span>
  git <span style="color: #ca3400;">\</span>
  libidn-devel <span style="color: #ca3400;">\</span>
  libltdl <span style="color: #ca3400;">\</span>
  libnettle-devel <span style="color: #ca3400;">\</span>
  libopenssl <span style="color: #ca3400;">\</span>
  libp11-kit-devel <span style="color: #ca3400;">\</span>
  libtasn1-devel <span style="color: #ca3400;">\</span>
  libunistring <span style="color: #ca3400;">\</span>
  make <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-toolchain <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-bzip2 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-cairo <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-crt-git <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-expat <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-fontconfig <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-freetype <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gcc <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gcc-libs <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gdk-pixbuf2 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gettext <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-giflib <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-glib2 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gmp <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-gnutls <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-harfbuzz <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-headers-git <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-imagemagick <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-jansson <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libgccjit <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libiconv <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libidn2 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libjpeg-turbo <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libpng <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-librsvg <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-sqlite3 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libtree-sitter <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libtiff <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libunistring <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-libxml2 <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-nettle <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-p11-kit <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-winpthreads <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-xpm-nox <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-xz <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-zlib <span style="color: #ca3400;">\</span>
  mingw-w64-ucrt-x86_64-jbigkit <span style="color: #ca3400;">\</span>
  pkgconf <span style="color: #ca3400;">\</span>
  texinfo 
</code></pre>
</div>
</div>
</div>
<div id="outline-container-org881ea2d" class="outline-2">
<h2 id="org881ea2d"><span class="section-number-2">3.</span> Fetch Emacs source</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-bash"><code>git config --global core.autocrlf false
git config --global http.postBuffer 524288000

git config --global http.proxy <span style="color: #ca3400;">"socks5://127.0.0.1:7890"</span>

git clone https://github.moeyy.xyz/https://github.com/emacs-mirror/emacs.git --depth 1
</code></pre>
</div>
</div>
</div>
<div id="outline-container-orgaf29f88" class="outline-2">
<h2 id="orgaf29f88"><span class="section-number-2">4.</span> Build Emacs</h2>
<div class="outline-text-2" id="text-4">
<p>
It is recommended to disable Windows Defender scan for MSYS2 or use<br>
Window 11 Dev Drive feature to speed up compilation.<br>
</p>
</div>
<div id="outline-container-orgf8bc788" class="outline-3">
<h3 id="orgf8bc788"><span class="section-number-3">4.1.</span> Configuration</h3>
<div class="outline-text-3" id="text-4-1">
<p>
It is important to <code>--with-gnutls</code>, because otherwise Emacs won't even<br>
able to use ELPA outside MSYS2. Also, dbus is not useful for Emacs on<br>
Windows. You may change other flags as you see appropriate.<br>
</p>

<p>
Set <code>prefix</code> to somewhere appropriate.<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code><span style="color: #557400;">cd</span> emacs &amp;&amp;<span style="color: #ca3400;">\</span>
./autogen.sh
mkdir build &amp;&amp;<span style="color: #ca3400;">\</span>
<span style="color: #557400;">cd</span> build &amp;&amp;<span style="color: #ca3400;">\</span>
<span style="color: #007a9f;">target</span>=/d/cemacs
../configure <span style="color: #007a9f;">prefix</span>=$<span style="color: #007a9f;">target</span> <span style="color: #ca3400;">\</span>
    --with-gnutls <span style="color: #ca3400;">\</span>
    --without-dbus <span style="color: #ca3400;">\</span>
    --with-native-compilation=aot <span style="color: #ca3400;">\</span>
    --without-pop <span style="color: #ca3400;">\</span>
    --with-xpm <span style="color: #ca3400;">\</span>
    --with-imagemagick <span style="color: #ca3400;">\</span>
    --with-modules
<span style="color: #8f6f4a;"># </span><span style="color: #8f6f4a;">&#22914;&#26524;&#35201;&#23581;&#35797;igc&#29256;&#26412;
</span>  --with-mps 
</code></pre>
</div>

<p>
Check if the configure log is appropriate.<br>
</p>
</div>
</div>
<div id="outline-container-org99d78a9" class="outline-3">
<h3 id="org99d78a9"><span class="section-number-3">4.2.</span> Building Emacs</h3>
<div class="outline-text-3" id="text-4-2">
<p>
备注：记得编译时关闭杀毒软件的实时防护功能，否则CPU占用率会很低。<br>
</p>

<p>
Then <code>make -j$(nproc)</code> it ( <code>make -j$(nproc) bootstrap</code> for develop branch). After building completes,<br>
<code>make install</code> and open the <code>$target</code> directory.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-orgf1bb8ba" class="outline-2">
<h2 id="orgf1bb8ba"><span class="section-number-2">5.</span> Post building</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgd1e4c3a" class="outline-3">
<h3 id="orgd1e4c3a"><span class="section-number-3">5.1.</span> DLL Hell</h3>
<div class="outline-text-3" id="text-5-1">
<p>
The easiest way is to copy all the dlls from <code>/ucrt64/bin</code>, and<br>
exploit the property that Windows won't allow delete currently opened<br>
files to trim it. Still that doesn't mean all the successfully deleted<br>
DLLs are safe to purge.  Before you hit "Clean Recycle Bin", it is a<br>
good idea to check against the Windows binary distributed by GNU for<br>
DLL used by Emacs.<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>cp /ucrt64/bin/*.dll $<span style="color: #007a9f;">target</span>/bin
</code></pre>
</div>

<p>
The good things is, even if you have found certain DLL is missing<br>
afterwards, you can still download the individual package without reinstall<br>
MSYS2.<br>
</p>
</div>
<div id="outline-container-orgd2e30a9" class="outline-4">
<h4 id="orgd2e30a9"><span class="section-number-4">5.1.1.</span> XPM image</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
This requires <code>libXpm-noX4.dll</code>. Emacs can start without this DLL<br>
but then it won't be able to display XPM image.<br>
</p>
</div>
</div>
<div id="outline-container-org96c9dab" class="outline-4">
<h4 id="org96c9dab"><span class="section-number-4">5.1.2.</span> Treesitter</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
<code>libtree-sitter.dll</code> depends on <code>wasmtime.dll</code>.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-org304cf3a" class="outline-3">
<h3 id="org304cf3a"><span class="section-number-3">5.2.</span> GCCJIT</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Additional works are required to make native compile work without complete<br>
MSYS2 environment.<br>
</p>

<div class="org-src-container">
<pre class="src src-bash"><code>mkdir $<span style="color: #007a9f;">target</span>/lib/gcc &amp;&amp;<span style="color: #ca3400;">\</span>
cp /ucrt64/lib/<span style="color: #a7601f;">{</span>crtbegin,crtend,dllcrt2<span style="color: #a7601f;">}</span>.o $<span style="color: #007a9f;">target</span>/lib/gcc &amp;&amp;<span style="color: #ca3400;">\</span>
cp /ucrt64/lib/lib<span style="color: #a7601f;">{</span>advapi32,gcc_s,mingw32,msvcrt,shell32,kernel32,mingwex,pthread,user32<span style="color: #a7601f;">}</span>.a $<span style="color: #007a9f;">target</span>/lib/gcc
</code></pre>
</div>

<p>
adjust path according to gcc version<br>
</p>
<div class="org-src-container">
<pre class="src src-bash"><code>cp /ucrt64/lib/gcc/x86_64-w64-mingw32/14.2.0/libgcc.a $<span style="color: #007a9f;">target</span>/lib/gcc &amp;&amp;<span style="color: #ca3400;">\</span>
cp /ucrt64/bin/<span style="color: #a7601f;">{</span>ld,as<span style="color: #a7601f;">}</span>.exe $<span style="color: #007a9f;">target</span>/lib/gcc
</code></pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb74ed1b" class="outline-2">
<h2 id="orgb74ed1b"><span class="section-number-2">6.</span> 其他相关软件</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org4413a06" class="outline-3">
<h3 id="org4413a06"><span class="section-number-3">6.1.</span> 使用ediff</h3>
<div class="outline-text-3" id="text-6-1">
<p>
下载<a href="https://github.com/wiltondb/diffutils_win">Github上预编译好</a>的diff.exe，然后放到path中就行。<br>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.8-pre)　|　<a href="https://tomoemami.github.io/rss.xml">RSS</a>　<a href="https://tomoemami.github.io/20251121T151653--english-post-index__wiki.html">English-Index</a></p>
</div>
</body>
</html>
