<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-01-06 周二 17:28 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>emacs-用denote配合ox-publish导出博客</title>
<meta name="generator" content="Org Mode" />
<link rel='stylesheet' type='text/css' href='/org.css'/>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="preamble" class="status">
<p>▼ 本文更新于 <span class="timestamp-wrapper"><span class="timestamp">[2026-01-06 周二 17:15]</span></span></p>
</div>
<div id="content" class="content">
<header>
<h1 class="title">emacs-用denote配合ox-publish导出博客</h1>
</header><p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2025-03-21T18:01:00">[2025-03-21 周五 18:01]</time></span><br>
</p>

<p>
之前写过一篇org-roam的相关教程：<a href="20240404T201255--使用advice自动更新ox-publish的待发布org-roam文件目录__blog.html">使用advice自动更新ox-publish的待发布org-roam文件目录</a>。现在切换到了denote，有必要更新一下相关代码了。<br>
</p>

<p>
直接使用denote时，可以把形如 <code>[[denote:]]</code> 的denote链接当作普通的 <code>[[file:]]</code> 链接。但是由于denote文件的文件名变化频繁，如果你和我一样选择通过网页手动上传导出的html文件到GitHub，则会遇见恼人的重复问题。另一方面，直接生成的文件链接也很长，很不直观。所以我们可以通过以下设置，将导出的文件名设置为denote标识符。<br>
</p>

<p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2025-03-25T11:17:00">[2025-03-25 周二 11:17]</time></span>： 这个函数自定义涉及到了许多导出的方面，缺乏可维护性。如果没有执着需求，建议不修改该函数。<br>
</p>

<p>
代码参考：<a href="https://gsj987.github.io/use-org-mode-publish-blog.html#org36c61a7">使用 org-mode 写博客</a><br>
</p>
<div id="outline-container-org4159484" class="outline-2">
<h2 id="org4159484"><span class="section-number-2">1.</span> 确定导出文件范围</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">my/ox-files</span> <span style="color: #557400;">()</span>
  <span style="color: #4f677f;">"Return a list of note files containing '</span><span style="color: #00824f;">blog</span><span style="color: #4f677f;">' tag."</span>
  <span style="color: #557400;">(</span>denote-directory-files <span style="color: #ca3400;">"_blog"</span><span style="color: #557400;">)</span><span style="color: #a7601f;">)</span>

</code></pre>
</div>
</div>
</div>
<div id="outline-container-org7547825" class="outline-2">
<h2 id="org7547825"><span class="section-number-2">2.</span> 自定义导出配置</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">my/org-project-update</span> <span style="color: #557400;">(</span><span style="color: #444fcf;">&amp;optional</span> ARG PRED<span style="color: #557400;">)</span> <span style="color: #8f6f4a;">;;</span><span style="color: #8f6f4a;">&#20351;&#29992;before&#20250;&#25509;&#25910;&#21040;&#21407;&#20989;&#25968;&#21442;&#25968;&#65292;&#22240;&#27492;&#38656;&#35201;&#28155;&#21152;optional
</span>  <span style="color: #557400;">(</span><span style="color: #006f00;">setq</span> org-publish-project-alist
        `<span style="color: #bf4400;">(</span><span style="color: #3f6faf;">(</span><span style="color: #ca3400;">"posts"</span>
           <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#24086;&#23376;&#37197;&#32622;&#39033;&#65292;&#30053;&#21435;&#20102;&#20854;&#20182;&#26080;&#20851;&#36873;&#39033;
</span>           <span style="color: #557400;">:exclude</span> <span style="color: #ca3400;">".*"</span>
           <span style="color: #557400;">:include</span> ,<span style="color: #00824f;">(</span>my/ox-files<span style="color: #00824f;">)</span>
           <span style="color: #557400;">:auto-sitemap</span> t
           <span style="color: #557400;">:html-link-home</span> <span style="color: #ca3400;">"index.html"</span>
           <span style="color: #557400;">:sitemap-filename</span> <span style="color: #ca3400;">"index.org"</span>
           <span style="color: #557400;">:sitemap-title</span> <span style="color: #ca3400;">"&#30446;&#24405;"</span>
           <span style="color: #557400;">:sitemap-format-entry</span> my/org-publish-sitemap-format-entry
           <span style="color: #3f6faf;">)</span>
          <span style="color: #3f6faf;">(</span><span style="color: #ca3400;">"static"</span>
           <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#38745;&#24577;&#36164;&#28304;&#37197;&#32622;&#39033;&#65292;&#30053;&#21435;)
</span>          <span style="color: #00824f;">(</span><span style="color: #ca3400;">"rss"</span>
           <span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">rss&#37197;&#32622;&#39033;&#65292;&#30053;&#21435;&#20102;&#20854;&#20182;&#26080;&#20851;&#36873;&#39033;
</span>           <span style="color: #557400;">:exclude</span> <span style="color: #ca3400;">".*"</span>
           <span style="color: #557400;">:include</span> ,<span style="color: #9a456f;">(</span>my/ox-files<span style="color: #9a456f;">)</span>
           <span style="color: #557400;">:publishing-function</span> publish-posts-rss-feed
           <span style="color: #557400;">:auto-sitemap</span> t
           <span style="color: #557400;">:sitemap-function</span> posts-rss-feed
           <span style="color: #557400;">:sitemap-format-entry</span> format-posts-rss-feed-entry<span style="color: #00824f;">)</span>
          <span style="color: #00824f;">(</span><span style="color: #ca3400;">"personal-website"</span> <span style="color: #557400;">:components</span> <span style="color: #9a456f;">(</span><span style="color: #ca3400;">"posts"</span> <span style="color: #ca3400;">"static"</span> <span style="color: #ca3400;">"rss"</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span>

<span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#20026;&#20102;&#30830;&#20445;&#21450;&#26102;&#21160;&#24577;&#26356;&#26032;&#23548;&#20986;&#25991;&#20214;&#30446;&#24405;&#65292;&#38656;&#35201;&#22312;&#23548;&#20986;&#20989;&#25968;&#25191;&#34892;&#21069;&#37325;&#26032;&#36171;&#20540;&#19968;&#27425; org-publish-project-alist
</span><span style="color: #557400;">(</span>advice-add 'org-export-dispatch <span style="color: #557400;">:before</span> 'my/org-project-update<span style="color: #557400;">)</span>
  
<span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#20197;&#19979;&#20989;&#25968;&#29992;&#20110;&#20462;&#25913;index.html/index.org&#30340;&#38142;&#25509;
</span><span style="color: #557400;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">my/org-publish-sitemap-format-entry</span> <span style="color: #bf4400;">(</span>entry style project<span style="color: #bf4400;">)</span>
  <span style="color: #4f677f;">"&#26684;&#24335;&#21270;&#31449;&#28857;&#22320;&#22270;&#20013;&#30340;&#27599;&#20010;&#26465;&#30446;&#65292;&#26174;&#31034;&#26631;&#39064;&#12289;&#26085;&#26399;&#21644;&#25688;&#35201;&#12290;"</span>
  <span style="color: #bf4400;">(</span><span style="color: #006f00;">let*</span> <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>title <span style="color: #9a456f;">(</span><span style="color: #006f00;">or</span> <span style="color: #a2604f;">(</span>org-publish-find-title entry project<span style="color: #a2604f;">)</span>
                        <span style="color: #a2604f;">(</span>file-name-base entry<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span>
         <span style="color: #00824f;">(</span>id <span style="color: #9a456f;">(</span>denote-retrieve-filename-identifier <span style="color: #a2604f;">(</span>file-name-base entry<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
    <span style="color: #3f6faf;">(</span>format <span style="color: #ca3400;">"[[denote:%s][%s]]\n"</span>
            id
            title<span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span>

<span style="color: #8f6f4a;">;; </span><span style="color: #8f6f4a;">&#20197;&#19979;&#20989;&#25968;&#29992;&#20110;&#20462;&#25913;rss.xml/rss.org&#30340;&#38142;&#25509;
</span><span style="color: #557400;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">publish-posts-rss-feed</span> <span style="color: #bf4400;">(</span>plist filename dir<span style="color: #bf4400;">)</span>
  <span style="color: #4f677f;">"Publish PLIST to RSS when FILENAME is rss.org.
DIR is the location of the output."</span>
  <span style="color: #bf4400;">(</span><span style="color: #006f00;">if</span> <span style="color: #3f6faf;">(</span>equal <span style="color: #ca3400;">"rss.org"</span> <span style="color: #00824f;">(</span>file-name-nondirectory filename<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
      <span style="color: #3f6faf;">(</span>org-rss-publish-to-rss plist filename dir<span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span>

<span style="color: #557400;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">format-posts-rss-feed-entry</span> <span style="color: #bf4400;">(</span>entry _style project<span style="color: #bf4400;">)</span>
  <span style="color: #4f677f;">"Format ENTRY for the posts RSS feed in PROJECT."</span>
  <span style="color: #bf4400;">(</span><span style="color: #006f00;">let*</span> <span style="color: #3f6faf;">(</span>
         <span style="color: #00824f;">(</span>title <span style="color: #9a456f;">(</span>org-publish-find-title entry project<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span>
         <span style="color: #00824f;">(</span>link <span style="color: #9a456f;">(</span>concat <span style="color: #a2604f;">(</span>denote-retrieve-filename-identifier <span style="color: #007a9f;">(</span>file-name-sans-extension entry<span style="color: #007a9f;">)</span><span style="color: #a2604f;">)</span> <span style="color: #ca3400;">".html"</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span>
         <span style="color: #00824f;">(</span>pubdate <span style="color: #9a456f;">(</span>format-time-string <span style="color: #a2604f;">(</span>car org-time-stamp-formats<span style="color: #a2604f;">)</span>
                                      <span style="color: #a2604f;">(</span>org-publish-find-date entry project<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
    <span style="color: #3f6faf;">(</span>message pubdate<span style="color: #3f6faf;">)</span>
    <span style="color: #3f6faf;">(</span>format <span style="color: #ca3400;">"%s
:properties:
:rss_permalink: %s
:pubdate: %s
:end:\n"</span>
            title
            link
            pubdate<span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span>
</code></pre>
</div>

<p>
有了上述函数，导出denote文件为html时就可以用标识符作为文件名称了。<br>
</p>
</div>
</div>
<div id="outline-container-org3db939d" class="outline-2">
<h2 id="org3db939d"><span class="section-number-2">3.</span> 修改导出链接处理函数</h2>
<div class="outline-text-2" id="text-3">
<p>
<span class="timestamp-wrapper"><time class="timestamp" datetime="2025-03-25T09:39:00">[2025-03-25 周二 09:39]</time></span><br>
</p>
<div class="org-src-container">
<pre class="src src-elisp"><code><span style="color: #a7601f;">(</span><span style="color: #006f00;">defun</span> <span style="color: #a7601f;">denote-link-ol-export</span> <span style="color: #557400;">(</span>link description format<span style="color: #557400;">)</span>
  <span style="color: #4f677f;">"Modified version of `</span><span style="color: #00824f;">denote-link-ol-export</span><span style="color: #4f677f;">'.
Retrieve ID, replace anchor with it

Original docstring below:
Export a `</span><span style="color: #00824f;">denote:</span><span style="color: #4f677f;">' link from Org files.
The LINK, DESCRIPTION, and FORMAT are handled by the export
backend."</span>
  <span style="color: #557400;">(</span><span style="color: #006f00;">let*</span> <span style="color: #bf4400;">(</span><span style="color: #3f6faf;">(</span>path-id <span style="color: #00824f;">(</span>denote-link--ol-resolve-link-to-target link <span style="color: #557400;">:full-data</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>path <span style="color: #00824f;">(</span>file-relative-name <span style="color: #9a456f;">(</span>nth 0 path-id<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>id <span style="color: #00824f;">(</span>nth 1 path-id<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>query <span style="color: #00824f;">(</span>nth 2 path-id<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>anchor <span style="color: #00824f;">(</span>file-name-sans-extension path<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
         <span style="color: #3f6faf;">(</span>desc <span style="color: #00824f;">(</span><span style="color: #006f00;">cond</span>
                <span style="color: #9a456f;">(</span>description<span style="color: #9a456f;">)</span>
                <span style="color: #9a456f;">(</span>query <span style="color: #a2604f;">(</span>format <span style="color: #ca3400;">"denote:%s::%s"</span> id query<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span>
                <span style="color: #9a456f;">(</span>t <span style="color: #a2604f;">(</span>concat <span style="color: #ca3400;">"denote:"</span> id<span style="color: #a2604f;">)</span><span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span>
    <span style="color: #bf4400;">(</span><span style="color: #006f00;">cond</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>eq format 'html<span style="color: #00824f;">)</span>
      <span style="color: #00824f;">(</span><span style="color: #006f00;">if</span> query
          <span style="color: #9a456f;">(</span>format <span style="color: #ca3400;">"&lt;a href=\"%s.html%s\"&gt;%s&lt;/a&gt;"</span> <span style="color: #a2604f;">(</span>denote-retrieve-filename-identifier anchor<span style="color: #a2604f;">)</span> query desc<span style="color: #9a456f;">)</span>
        <span style="color: #9a456f;">(</span>format <span style="color: #ca3400;">"&lt;a href=\"%s.html\"&gt;%s&lt;/a&gt;"</span> <span style="color: #a2604f;">(</span>denote-retrieve-filename-identifier anchor<span style="color: #a2604f;">)</span> desc<span style="color: #9a456f;">)</span><span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>eq format 'latex<span style="color: #00824f;">)</span> <span style="color: #00824f;">(</span>format <span style="color: #ca3400;">"\\href{%s}{%s}"</span> <span style="color: #9a456f;">(</span>replace-regexp-in-string <span style="color: #ca3400;">"[\\{}$%&amp;_#~^]"</span> <span style="color: #ca3400;">"\\\\\\&amp;"</span> path<span style="color: #9a456f;">)</span> desc<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>eq format 'texinfo<span style="color: #00824f;">)</span> <span style="color: #00824f;">(</span>format <span style="color: #ca3400;">"@uref{%s,%s}"</span> path desc<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>eq format 'ascii<span style="color: #00824f;">)</span> <span style="color: #00824f;">(</span>format <span style="color: #ca3400;">"[%s] &lt;denote:%s&gt;"</span> desc path<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span><span style="color: #00824f;">(</span>eq format 'md<span style="color: #00824f;">)</span> <span style="color: #00824f;">(</span>format <span style="color: #ca3400;">"[%s](%s)"</span> desc path<span style="color: #00824f;">)</span><span style="color: #3f6faf;">)</span>
     <span style="color: #3f6faf;">(</span>t path<span style="color: #3f6faf;">)</span><span style="color: #bf4400;">)</span><span style="color: #557400;">)</span><span style="color: #a7601f;">)</span>
</code></pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p>© Published by <a href="https://www.gnu.org/software/emacs/">Emacs</a> 31.0.50 (<a href="https://orgmode.org">Org</a> mode 9.8-pre)　|　<a href="https://tomoemami.github.io/rss.xml">RSS</a>　<a href="https://tomoemami.github.io/20251121T151653--english-post-index__wiki.html">English-Index</a></p>
</div>
</body>
</html>
